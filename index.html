<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#04060f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Fibertel Center">
<meta name="application-name" content="Fibertel Center">
<meta name="description" content="Sistema de gesti√≥n para Fibertel Center ‚Äî ventas, comisiones y decomisiones">
<title>Fibertel Center ‚Äî Sistema de Gesti√≥n 2026</title>
<!-- PWA MANIFEST INLINE -->
<script>
(function(){
  const manifest = {
    name: "Fibertel Center",
    short_name: "FibertelFC",
    description: "Sistema de gesti√≥n ‚Äî ventas, comisiones, decomisiones",
    start_url: "./",
    display: "standalone",
    orientation: "portrait-primary",
    background_color: "#04060f",
    theme_color: "#00ffe1",
    lang: "es",
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='38' fill='%2304060f'/%3E%3Crect x='4' y='4' width='184' height='184' rx='35' fill='none' stroke='%2300ffe1' stroke-width='3' opacity='.4'/%3E%3Ctext x='50%25' y='58%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black,Arial' font-weight='900' font-size='88' fill='%2300ffe1'%3EFC%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml", purpose: "any maskable" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='90' fill='%2304060f'/%3E%3Crect x='6' y='6' width='500' height='500' rx='85' fill='none' stroke='%2300ffe1' stroke-width='6' opacity='.4'/%3E%3Ctext x='50%25' y='58%25' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black,Arial' font-weight='900' font-size='230' fill='%2300ffe1'%3EFC%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml", purpose: "any maskable" }
    ],
    shortcuts: [
      { name: "Nueva Venta", short_name: "Venta", description: "Registrar nueva venta", url: "./?page=ventas" },
      { name: "Dashboard", short_name: "Panel", description: "Ver panel principal", url: "./?page=dashboard" }
    ],
    categories: ["business", "finance", "productivity"]
  };
  const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('link');
  link.rel = 'manifest'; link.href = url;
  document.currentScript.parentNode.insertBefore(link, document.currentScript);
})();
</script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ROOT VARIABLES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
:root{
  --bg:#04060f;--s1:#080d1c;--s2:#0c1228;--s3:#111a38;
  --b1:rgba(255,255,255,0.055);--b2:rgba(255,255,255,0.10);--b3:rgba(255,255,255,0.16);
  --neon:#00ffe1;--neon2:#00c8b4;--neon-glow:rgba(0,255,225,0.2);
  --hot:#ff2d6e;--hot-glow:rgba(255,45,110,0.18);
  --gold:#f5c842;--gold-glow:rgba(245,200,66,0.15);
  --volt:#c8ff00;--purple:#b06aff;--blue:#4da6ff;--cyan:#06e0e0;
  --green:#10e89a;--green-g:rgba(16,232,154,0.15);
  --red:#ff4466;--red-g:rgba(255,68,102,0.15);
  --amber:#ffb020;--amber-g:rgba(255,176,32,0.15);
  --txt:#e8eeff;--txt2:#8898c0;--txt3:#3d4f78;
  --sw:262px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--txt);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden;text-transform:uppercase;letter-spacing:.2px;}
input,textarea,select,p,code,pre,.lower,.modal-sub,.card-sub,.nsec,td,th,label{text-transform:none;letter-spacing:normal;}

/* ‚ïê‚ïê‚ïê ANIMATED BG ‚ïê‚ïê‚ïê */
#bgCanvas{position:fixed;inset:0;z-index:0;pointer-events:none;}
.orb{position:fixed;border-radius:50%;pointer-events:none;z-index:0;filter:blur(110px);animation:orbF 14s ease-in-out infinite;}
.orb1{width:750px;height:750px;background:radial-gradient(circle,rgba(0,255,225,0.05),transparent 70%);top:-280px;right:-180px;}
.orb2{width:600px;height:600px;background:radial-gradient(circle,rgba(255,45,110,0.04),transparent 70%);bottom:-200px;left:-180px;animation-delay:-5s;}
.orb3{width:500px;height:500px;background:radial-gradient(circle,rgba(176,106,255,0.04),transparent 70%);top:35%;left:20%;animation-delay:-9s;}
@keyframes orbF{0%,100%{transform:translate(0,0) scale(1);}33%{transform:translate(28px,-40px) scale(1.05);}66%{transform:translate(-22px,28px) scale(0.95);}}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:linear-gradient(rgba(0,255,225,0.016) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,225,0.016) 1px,transparent 1px);
  background-size:55px 55px;animation:gridShift 28s linear infinite;}
@keyframes gridShift{0%{background-position:0 0;}100%{background-position:55px 55px;}}
body::after{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{position:fixed;left:0;top:0;bottom:0;width:var(--sw);background:rgba(6,10,22,0.97);backdrop-filter:blur(24px) saturate(1.6);border-right:1px solid var(--b1);display:flex;flex-direction:column;z-index:100;transition:transform .3s cubic-bezier(.77,0,.18,1);overflow-y:auto;}
.sidebar-glow{position:absolute;right:0;top:0;bottom:0;width:1px;background:linear-gradient(180deg,transparent,var(--neon) 25%,var(--purple) 60%,var(--hot) 85%,transparent);opacity:.15;}
.logo-wrap{padding:22px 18px 14px;}
.logo-badge{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
.logo-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--neon),var(--blue));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:0;color:#04060f;box-shadow:0 0 22px var(--neon-glow);}
.logo-name{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--txt);}
.logo-name span{color:var(--neon);}
.logo-sub{font-size:7.5px;color:var(--txt3);letter-spacing:3px;text-transform:uppercase;font-family:'DM Mono',monospace;padding-left:50px;}
.user-wrap{position:relative;margin:0 10px 6px;}
.user-card{background:var(--s2);border:1px solid var(--b1);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:9px;cursor:pointer;transition:border-color .2s;}
.user-card:hover{border-color:rgba(0,255,225,0.25);}
.uc-av{width:32px;height:32px;border-radius:8px;flex-shrink:0;background:linear-gradient(135deg,var(--neon),var(--purple));display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:#04060f;}
.uc-name{font-size:12.5px;font-weight:600;letter-spacing:.2px;}
.uc-role{font-size:8px;color:var(--neon);letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.uc-dot{margin-left:auto;width:7px;height:7px;border-radius:50%;background:var(--neon);box-shadow:0 0 6px var(--neon);}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.4;}}
.udrop{position:absolute;bottom:calc(100% + 6px);left:0;right:0;background:rgba(8,13,28,0.98);border:1px solid var(--b2);border-radius:12px;padding:5px;display:none;z-index:200;box-shadow:0 18px 50px rgba(0,0,0,.6);}
.udrop.open{display:block;}
.udrop-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;font-size:11.5px;color:var(--txt2);cursor:pointer;transition:all .13s;text-transform:none;}
.udrop-item:hover{background:rgba(0,255,225,0.05);color:var(--neon);}
.udrop-item.danger:hover{background:rgba(255,45,110,0.08);color:var(--hot);}
.udrop-sep{height:1px;background:var(--b1);margin:3px 0;}
nav{padding:3px 8px;flex:1;overflow-y:auto;}
nav::-webkit-scrollbar{width:3px;}nav::-webkit-scrollbar-thumb{background:var(--b2);border-radius:99px;}
.nsec{font-size:7.5px;letter-spacing:3px;color:var(--txt3);text-transform:uppercase;padding:12px 10px 4px;font-family:'DM Mono',monospace;}
.ni{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:10px;cursor:pointer;margin-bottom:2px;color:var(--txt2);font-size:12px;font-weight:500;transition:all .18s;position:relative;overflow:hidden;letter-spacing:.1px;text-transform:uppercase;}
.ni::before{content:'';position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,var(--neon),transparent);opacity:.5;transition:width .25s;border-radius:0 99px 99px 0;}
.ni:hover{background:rgba(0,255,225,0.04);color:var(--txt);}
.ni:hover::before{width:3px;}
.ni.active{background:linear-gradient(90deg,rgba(0,255,225,0.09),rgba(0,255,225,0.02));color:var(--neon);border:1px solid rgba(0,255,225,0.15);}
.ni.active::before{width:3px;}
.ni svg{width:14px;height:14px;flex-shrink:0;stroke-width:1.8;}
.nbadge{margin-left:auto;font-size:8.5px;font-weight:700;padding:2px 7px;border-radius:99px;font-family:'DM Mono',monospace;}
.nbadge.r{background:rgba(255,45,110,.14);color:var(--hot);}
.nbadge.a{background:rgba(255,176,32,.14);color:var(--amber);}
.nbadge.g{background:rgba(0,255,225,.12);color:var(--neon);}
.sbot{padding:10px 12px 18px;border-top:1px solid var(--b1);}
.gs-status{background:rgba(0,255,225,0.04);border:1px solid rgba(0,255,225,0.12);border-radius:11px;padding:10px 12px;margin-bottom:8px;}
.gs-status-lbl{font-size:7.5px;letter-spacing:2px;color:var(--txt3);text-transform:uppercase;font-family:'DM Mono',monospace;margin-bottom:4px;}
.gs-status-val{font-size:11px;font-weight:600;color:var(--neon);display:flex;align-items:center;gap:6px;}
.gs-dot{width:7px;height:7px;border-radius:50%;background:var(--txt3);flex-shrink:0;}
.gs-dot.on{background:var(--neon);box-shadow:0 0 8px var(--neon);animation:blink 2s ease-in-out infinite;}
.gs-dot.syncing{background:var(--amber);animation:blink .8s ease-in-out infinite;}
.risk-box{background:rgba(255,45,110,0.05);border:1px solid rgba(255,45,110,0.15);border-radius:11px;padding:10px 12px;}
.risk-lbl{font-size:7.5px;letter-spacing:2px;color:var(--hot);text-transform:uppercase;font-family:'DM Mono',monospace;margin-bottom:4px;}
.risk-val{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:var(--hot);}
.risk-sub{font-size:9.5px;color:var(--txt2);}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{margin-left:var(--sw);padding:26px 30px;min-height:100vh;position:relative;z-index:1;}
.page{display:none;}.page.active{display:block;animation:pageIn .35s cubic-bezier(.77,0,.18,1);}
@keyframes pageIn{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:none;}}
.ph{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;}
.ph-eye{font-size:7.5px;letter-spacing:3.5px;text-transform:uppercase;color:var(--neon);font-family:'DM Mono',monospace;margin-bottom:5px;display:flex;align-items:center;gap:6px;}
.ph-eye::before{content:'';width:14px;height:1px;background:var(--neon);}
.ph h2{font-family:'Bebas Neue',sans-serif;font-size:36px;font-weight:400;letter-spacing:2px;line-height:1;}
.ph p{color:var(--txt2);font-size:12px;margin-top:3px;text-transform:none;letter-spacing:normal;}
.ph-acts{display:flex;gap:8px;padding-top:3px;}
.btn{padding:8px 18px;border-radius:10px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;transition:all .18s;letter-spacing:.3px;}
.btn-neon{background:var(--neon);color:#04060f;box-shadow:0 0 18px var(--neon-glow);}
.btn-neon:hover{box-shadow:0 0 35px rgba(0,255,225,.4);transform:translateY(-1px);}
.btn-ghost{background:var(--s2);color:var(--txt2);border:1px solid var(--b2);}
.btn-ghost:hover{border-color:var(--neon);color:var(--neon);}
.btn-amber{background:var(--amber);color:#04060f;}
.btn-amber:hover{box-shadow:0 0 25px var(--amber-g);transform:translateY(-1px);}
.btn-hot{background:var(--hot);color:#fff;box-shadow:0 0 16px var(--hot-glow);}
.btn-hot:hover{box-shadow:0 0 30px rgba(255,45,110,.4);transform:translateY(-1px);}
.btn-green{background:var(--green);color:#04060f;}
.btn-green:hover{box-shadow:0 0 22px var(--green-g);transform:translateY(-1px);}
.btn-sm{padding:6px 14px;font-size:11px;}

/* ‚ïê‚ïê‚ïê METRICS ‚ïê‚ïê‚ïê */
.metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:11px;margin-bottom:16px;}
.metrics-3{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:16px;}
.mc{background:rgba(8,13,28,0.75);border:1px solid var(--b1);border-radius:18px;padding:18px;position:relative;overflow:hidden;backdrop-filter:blur(10px);transition:transform .22s,border-color .22s,box-shadow .22s;}
.mc:hover{transform:translateY(-3px);}
.mc::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.mc::after{content:'';position:absolute;width:120px;height:120px;border-radius:50%;bottom:-40px;right:-40px;filter:blur(35px);}
.mc.m-g::before{background:linear-gradient(90deg,var(--neon),transparent);}
.mc.m-g::after{background:rgba(0,255,225,0.06);}
.mc.m-g:hover{border-color:rgba(0,255,225,0.25);box-shadow:0 18px 55px rgba(0,255,225,0.07);}
.mc.m-r::before{background:linear-gradient(90deg,var(--hot),transparent);}
.mc.m-r::after{background:rgba(255,45,110,0.06);}
.mc.m-r:hover{border-color:rgba(255,45,110,0.25);box-shadow:0 18px 55px rgba(255,45,110,0.07);}
.mc.m-b::before{background:linear-gradient(90deg,var(--blue),transparent);}
.mc.m-b::after{background:rgba(77,166,255,0.06);}
.mc.m-b:hover{border-color:rgba(77,166,255,0.25);}
.mc.m-a::before{background:linear-gradient(90deg,var(--amber),transparent);}
.mc.m-a::after{background:rgba(255,176,32,0.06);}
.mc.m-a:hover{border-color:rgba(255,176,32,0.25);}
.mc.m-v::before{background:linear-gradient(90deg,var(--purple),transparent);}
.mc.m-v::after{background:rgba(176,106,255,0.06);}
.mc.m-v:hover{border-color:rgba(176,106,255,0.25);}
.mc.m-c::before{background:linear-gradient(90deg,var(--cyan),transparent);}
.mc.m-c::after{background:rgba(6,224,224,0.06);}
.mc-lbl{font-size:7.5px;letter-spacing:2.5px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:9px;}
.mc-val{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1px;margin-bottom:5px;text-transform:none;}
.mc-sub{font-size:10px;color:var(--txt2);text-transform:none;letter-spacing:normal;}
.mc-ico{position:absolute;top:14px;right:14px;font-size:18px;opacity:.5;}
.pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:99px;font-size:9px;font-weight:700;font-family:'DM Mono',monospace;}
.pill-g{background:rgba(0,255,225,.1);color:var(--neon);}
.pill-r{background:rgba(255,45,110,.1);color:var(--hot);}
.pill-a{background:rgba(255,176,32,.1);color:var(--amber);}
.pill-b{background:rgba(77,166,255,.1);color:var(--blue);}
.pill-v{background:rgba(176,106,255,.1);color:var(--purple);}
.pill-c{background:rgba(6,224,224,.1);color:var(--cyan);}

/* ‚ïê‚ïê‚ïê CARDS ‚ïê‚ïê‚ïê */
.card{background:rgba(8,13,28,0.75);border:1px solid var(--b1);border-radius:18px;padding:20px;backdrop-filter:blur(10px);transition:border-color .2s;position:relative;}
.card:hover{border-color:var(--b2);}
.card::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:40%;height:1px;background:linear-gradient(90deg,transparent,var(--neon),transparent);opacity:.1;}
.card-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;margin-bottom:2px;}
.card-sub{font-size:9px;color:var(--txt3);font-family:'DM Mono',monospace;letter-spacing:.5px;margin-bottom:14px;text-transform:none;}
.charts2{display:grid;grid-template-columns:1.55fr 1fr;gap:11px;margin-bottom:16px;}
.charts3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:11px;margin-bottom:16px;}

/* ‚ïê‚ïê‚ïê TABLE ‚ïê‚ïê‚ïê */
.tcard{background:rgba(8,13,28,0.75);border:1px solid var(--b1);border-radius:18px;overflow:hidden;backdrop-filter:blur(10px);margin-bottom:16px;}
.tbar{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--b1);}
.tbar-title{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;padding:8px 14px;font-size:7px;letter-spacing:2.5px;text-transform:uppercase;color:var(--txt3);background:rgba(255,255,255,.012);font-family:'DM Mono',monospace;}
td{padding:10px 14px;font-size:12px;border-top:1px solid rgba(255,255,255,.04);}
tr{transition:background .1s;}
tr:hover td{background:rgba(0,255,225,0.025);}
.av{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.ar{display:flex;align-items:center;gap:8px;}

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
.modal-overlay{position:fixed;inset:0;background:rgba(4,6,15,0.88);backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .22s;}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal{background:linear-gradient(135deg,rgba(8,13,28,0.99),rgba(4,6,15,0.99));border:1px solid var(--b2);border-radius:20px;padding:26px;width:500px;max-width:94vw;max-height:90vh;overflow-y:auto;transform:scale(.94) translateY(16px);transition:transform .28s cubic-bezier(.34,1.56,.64,1);position:relative;box-shadow:0 40px 100px rgba(0,0,0,.7);}
.modal::before{content:'';position:absolute;top:0;left:22%;right:22%;height:1px;background:linear-gradient(90deg,transparent,var(--neon),transparent);opacity:.35;}
.modal-overlay.open .modal{transform:scale(1) translateY(0);}
.modal-wide{width:680px;}
.modal-x{position:absolute;top:14px;right:14px;width:28px;height:28px;border-radius:7px;background:var(--s2);border:1px solid var(--b2);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--txt2);font-size:12px;transition:all .13s;}
.modal-x:hover{background:rgba(255,45,110,.12);color:var(--hot);border-color:var(--hot);}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;margin-bottom:2px;}
.modal-sub{color:var(--txt2);font-size:11px;margin-bottom:18px;font-weight:300;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.frow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;}
.fg{margin-bottom:9px;}
label{display:block;font-size:7.5px;color:var(--txt2);margin-bottom:5px;font-weight:600;letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;}
input,select,textarea{width:100%;background:var(--s2);border:1px solid var(--b1);color:var(--txt);padding:8px 11px;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:12.5px;transition:all .16s;outline:none;}
input:focus,select:focus,textarea:focus{border-color:rgba(0,255,225,.5);box-shadow:0 0 0 3px rgba(0,255,225,.06);}
select option{background:var(--s2);}
.macts{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:14px;border-top:1px solid var(--b1);}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
#toast-wrap{position:fixed;bottom:22px;right:22px;z-index:9999;display:flex;flex-direction:column;gap:8px;}
.toast-item{background:rgba(8,13,28,0.97);border:1px solid var(--b2);color:var(--txt);padding:10px 16px;border-radius:12px;font-size:12px;font-weight:500;transform:translateX(80px);opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);backdrop-filter:blur(20px);box-shadow:0 14px 40px rgba(0,0,0,.45);display:flex;align-items:center;gap:8px;max-width:300px;}
.toast-item.show{transform:translateX(0);opacity:1;}
.toast-item.t-ok{border-color:rgba(0,255,225,.25);}
.toast-item.t-err{border-color:rgba(255,45,110,.25);}
.toast-item.t-warn{border-color:rgba(255,176,32,.25);}

/* ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê */
#login-screen{position:fixed;inset:0;z-index:9000;display:flex;align-items:center;justify-content:center;background:var(--bg);transition:opacity .5s;}
#login-screen.hiding{opacity:0;pointer-events:none;}
#login-screen.hidden{display:none;}
.lbox{width:420px;max-width:93vw;background:rgba(8,13,28,0.96);border:1px solid var(--b2);border-radius:24px;padding:36px 32px;box-shadow:0 50px 120px rgba(0,0,0,.8);animation:lboxIn .5s cubic-bezier(.34,1.56,.64,1) both;position:relative;}
@keyframes lboxIn{from{opacity:0;transform:translateY(30px) scale(.96);}to{opacity:1;transform:none;}}
.lbox::before{content:'';position:absolute;top:0;left:22%;right:22%;height:1px;background:linear-gradient(90deg,transparent,var(--neon),transparent);opacity:.4;}
.l-logo{display:flex;align-items:center;gap:11px;margin-bottom:24px;justify-content:center;}
.l-icon{width:44px;height:44px;border-radius:11px;background:linear-gradient(135deg,var(--neon),var(--blue));display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:0;color:#04060f;box-shadow:0 0 28px var(--neon-glow);}
.l-title{font-family:'Bebas Neue',sans-serif;font-size:24px;letter-spacing:2px;color:var(--txt);}
.l-title span{color:var(--neon);}
.l-tabs{display:flex;margin-bottom:22px;background:var(--s2);border-radius:10px;padding:3px;border:1px solid var(--b1);}
.l-tab{flex:1;padding:7px;border-radius:8px;text-align:center;font-size:11px;font-weight:700;cursor:pointer;color:var(--txt2);font-family:'DM Mono',monospace;letter-spacing:2px;transition:all .18s;}
.l-tab.active{background:rgba(0,255,225,.1);color:var(--neon);border:1px solid rgba(0,255,225,.2);}
.l-form{display:flex;flex-direction:column;gap:11px;}
.l-field{position:relative;}
.l-field label{font-size:8px;color:var(--txt3);display:block;margin-bottom:4px;letter-spacing:2px;text-transform:uppercase;font-family:'DM Mono',monospace;}
.l-field input{width:100%;background:var(--s2);border:1px solid var(--b1);color:var(--txt);padding:10px 36px 10px 12px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;transition:all .16s;outline:none;}
.l-field input:focus{border-color:rgba(0,255,225,.45);box-shadow:0 0 0 3px rgba(0,255,225,.06);}
.l-ico{position:absolute;right:11px;bottom:11px;font-size:14px;color:var(--txt3);pointer-events:none;}
.l-tog{position:absolute;right:11px;bottom:10px;font-size:13px;color:var(--txt3);cursor:pointer;background:none;border:none;transition:color .13s;}
.l-tog:hover{color:var(--neon);}
.l-err{background:rgba(255,45,110,.07);border:1px solid rgba(255,45,110,.18);border-radius:9px;padding:8px 12px;font-size:11px;color:var(--hot);text-align:center;display:none;font-family:'DM Mono',monospace;}
.l-err.show{display:block;}
.l-ok{background:rgba(0,255,225,.06);border:1px solid rgba(0,255,225,.18);border-radius:9px;padding:8px 12px;font-size:11px;color:var(--neon);text-align:center;display:none;font-family:'DM Mono',monospace;}
.l-ok.show{display:block;}
.btn-login{width:100%;padding:13px;border-radius:11px;border:none;cursor:pointer;background:linear-gradient(135deg,var(--neon),var(--blue));color:#04060f;font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;box-shadow:0 0 28px var(--neon-glow);transition:all .18s;margin-top:2px;}
.btn-login:hover{box-shadow:0 0 45px rgba(0,255,225,.5);transform:translateY(-1px);}
.l-qbtn{width:100%;padding:9px;border-radius:10px;background:var(--s2);border:1px solid var(--b2);color:var(--txt2);font-family:'DM Sans',sans-serif;font-size:12px;cursor:pointer;transition:all .15s;text-align:left;display:flex;align-items:center;gap:9px;margin-bottom:6px;}
.l-qbtn:hover{border-color:var(--neon);color:var(--neon);background:rgba(0,255,225,.04);}
.l-qbtn span{font-size:9px;color:var(--txt3);font-family:'DM Mono',monospace;margin-left:auto;}
.l-spin{width:38px;height:38px;border-radius:50%;border:2px solid var(--b2);border-top-color:var(--neon);animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.l-loading{display:none;flex-direction:column;align-items:center;gap:12px;padding:14px 0;}
.l-loading.show{display:flex;}
.l-loading-txt{font-family:'DM Mono',monospace;font-size:10px;color:var(--neon);letter-spacing:2px;text-transform:uppercase;}
.l-div{display:flex;align-items:center;gap:9px;color:var(--txt3);font-size:9px;letter-spacing:2px;font-family:'DM Mono',monospace;}
.l-div::before,.l-div::after{content:'';flex:1;height:1px;background:var(--b2);}
.l-footer{margin-top:16px;text-align:center;font-size:9px;color:var(--txt3);font-family:'DM Mono',monospace;}

/* ‚ïê‚ïê‚ïê AGENT CARDS ‚ïê‚ïê‚ïê */
.aperf{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:16px;}
.ap-card{background:rgba(8,13,28,0.75);border:1px solid var(--b1);border-radius:16px;padding:16px;backdrop-filter:blur(10px);transition:all .18s;position:relative;overflow:hidden;}
.ap-card:hover{transform:translateY(-3px);border-color:var(--b2);}
.ap-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:9px;}
.ap-av{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:#fff;}
.ap-name{font-size:13px;font-weight:700;margin-bottom:1px;letter-spacing:.2px;}
.pbar{height:3px;background:var(--s3);border-radius:99px;overflow:hidden;margin:7px 0 4px;}
.pfill{height:100%;border-radius:99px;transition:width .5s ease;}
.db{background:none;border:none;cursor:pointer;color:var(--txt3);font-size:12px;padding:4px;border-radius:6px;transition:all .12s;}
.db:hover{background:rgba(255,45,110,.1);color:var(--hot);}
.empty{text-align:center;padding:38px 16px;color:var(--txt3);font-size:12px;text-transform:none;letter-spacing:normal;}

/* ‚ïê‚ïê‚ïê EDU FINANCIERA ‚ïê‚ïê‚ïê */
.edu-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.edu-card{background:rgba(8,13,28,0.75);border:1px solid var(--b1);border-radius:18px;padding:22px;backdrop-filter:blur(10px);transition:all .22s;position:relative;overflow:hidden;}
.edu-card:hover{transform:translateY(-3px);border-color:var(--b2);}
.edu-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--neon),transparent);}
.edu-tag{font-size:8px;letter-spacing:3px;text-transform:uppercase;color:var(--neon);font-family:'DM Mono',monospace;margin-bottom:7px;}
.edu-title{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1.5px;margin-bottom:8px;}
.edu-desc{font-size:12px;color:var(--txt2);line-height:1.7;font-weight:300;text-transform:none;letter-spacing:normal;margin-bottom:14px;}
.edu-calc{background:var(--s2);border:1px solid var(--b1);border-radius:12px;padding:14px;}
.edu-calc-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:10px;}
.edu-calc input{background:var(--s3);border:1px solid var(--b2);color:var(--txt);padding:8px 11px;border-radius:8px;font-size:12px;width:100%;margin-bottom:8px;font-family:'DM Sans',sans-serif;outline:none;}
.edu-calc input:focus{border-color:rgba(0,255,225,.4);}
.edu-result{background:rgba(0,255,225,0.04);border:1px solid rgba(0,255,225,0.15);border-radius:9px;padding:10px 13px;font-family:'DM Mono',monospace;font-size:11.5px;color:var(--neon);text-transform:none;letter-spacing:normal;line-height:1.6;}
.salary-breakdown{display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-top:14px;}
.sb-item{background:var(--b1);border-radius:10px;padding:11px;text-align:center;}
.sb-lbl{font-size:7.5px;letter-spacing:1.5px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:5px;}
.sb-val{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:1px;text-transform:none;}

/* ‚ïê‚ïê‚ïê GS MODAL ‚ïê‚ïê‚ïê */
.gs-step{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--b1);font-size:12px;color:var(--txt2);text-transform:none;letter-spacing:normal;line-height:1.5;}
.gs-step-num{color:var(--neon);font-family:'DM Mono',monospace;font-weight:700;min-width:20px;}
.code-block{background:#060b18;border:1px solid var(--b2);border-radius:11px;padding:14px;max-height:340px;overflow-y:auto;margin-bottom:14px;}
.code-block pre{font-family:'DM Mono',monospace;font-size:10.5px;color:var(--neon);white-space:pre-wrap;text-transform:none;letter-spacing:normal;line-height:1.6;}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:1100px){.metrics{grid-template-columns:repeat(2,1fr);}.charts2{grid-template-columns:1fr;}.aperf{grid-template-columns:repeat(2,1fr);}.edu-grid{grid-template-columns:1fr;}.salary-breakdown{grid-template-columns:1fr 1fr;}}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%);transition:transform .3s cubic-bezier(.77,0,.18,1);}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;padding:14px;}
  .metrics{grid-template-columns:1fr 1fr;}
  .frow,.frow3{grid-template-columns:1fr;}
  .ph h2{font-size:26px;}
  .ph{flex-wrap:wrap;gap:10px;}
}

/* ‚îÄ‚îÄ HAMBURGER BUTTON ‚îÄ‚îÄ */
.mob-toggle{
  display:none;
  position:fixed;top:14px;left:14px;z-index:200;
  width:42px;height:42px;border-radius:11px;
  background:rgba(8,13,28,0.95);
  border:1px solid rgba(0,255,225,0.2);
  backdrop-filter:blur(14px);
  cursor:pointer;align-items:center;justify-content:center;
  flex-direction:column;gap:5px;
  box-shadow:0 4px 20px rgba(0,0,0,0.4);
  transition:all .2s;
}
.mob-toggle:hover{border-color:rgba(0,255,225,0.5);}
.mob-toggle span{
  display:block;width:18px;height:2px;
  background:var(--neon);border-radius:99px;
  transition:all .25s cubic-bezier(.77,0,.18,1);
}
.mob-toggle.open span:nth-child(1){transform:translateY(7px) rotate(45deg);}
.mob-toggle.open span:nth-child(2){opacity:0;transform:scaleX(0);}
.mob-toggle.open span:nth-child(3){transform:translateY(-7px) rotate(-45deg);}
@media(max-width:768px){.mob-toggle{display:flex;}.main{padding-top:70px;}}

/* ‚îÄ‚îÄ SIDEBAR OVERLAY (tap fuera para cerrar) ‚îÄ‚îÄ */
.sidebar-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(4,6,15,0.6);backdrop-filter:blur(3px);
  z-index:99;
}
.sidebar-overlay.open{display:block;}

/* Scrollbar */
::-webkit-scrollbar{width:3px;height:3px;}::-webkit-scrollbar-thumb{background:var(--s3);border-radius:99px;}::-webkit-scrollbar-thumb:hover{background:var(--b2);}
</style>
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="orb orb1"></div><div class="orb orb2"></div><div class="orb orb3"></div>

<!-- HAMBURGER BUTTON (solo m√≥vil) -->
<button class="mob-toggle" id="mob-toggle" onclick="toggleSidebar()" aria-label="Men√∫">
  <span></span><span></span><span></span>
</button>

<!-- OVERLAY para cerrar sidebar tocando fuera -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- SYNC OVERLAY ‚Äî pantalla de carga al sincronizar -->
<div id="sync-overlay" style="
  display:none;position:fixed;inset:0;z-index:5000;
  background:rgba(4,6,15,0.92);backdrop-filter:blur(12px);
  flex-direction:column;align-items:center;justify-content:center;gap:18px;">
  <div style="width:54px;height:54px;border-radius:50%;border:3px solid rgba(0,255,225,0.15);border-top-color:var(--neon);animation:spin .8s linear infinite;"></div>
  <div style="font-family:'DM Mono',monospace;font-size:12px;color:var(--neon);letter-spacing:3px;text-transform:uppercase;" id="sync-overlay-txt">Sincronizando...</div>
  <div style="font-size:11px;color:var(--txt3);text-transform:none;letter-spacing:normal;">Cargando tus datos desde Google Sheets</div>
  <button onclick="hideSyncOverlay()" style="margin-top:10px;background:transparent;border:1px solid var(--b2);color:var(--txt3);padding:7px 18px;border-radius:8px;cursor:pointer;font-size:11px;font-family:'DM Sans',sans-serif;">Saltar (usar datos locales)</button>
</div>

<!-- LOGIN -->
<div id="login-screen">
<div class="lbox">
  <div class="l-logo">
    <div class="l-icon">FC</div>
    <div class="l-title">Fibertel<span>Center</span></div>
  </div>
  <div class="l-tabs">
    <div class="l-tab active" id="tab-login" onclick="switchTab('login')">INGRESAR</div>
    <div class="l-tab" id="tab-register" onclick="switchTab('register')">REGISTRAR</div>
  </div>
  <div id="form-login">
    <div class="l-form">
      <div class="l-field"><label>Usuario o Email</label><input type="text" id="l-user" placeholder="admin" autocomplete="username"><span class="l-ico">‚óà</span></div>
      <div class="l-field"><label>Contrase√±a</label><input type="password" id="l-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"><button class="l-tog" onclick="togglePass('l-pass',this)" type="button">üëÅ</button></div>
      <div class="l-err" id="l-error">‚ö† Usuario o contrase√±a incorrectos</div>
      <button class="btn-login" onclick="doLogin()">ACCEDER AL SISTEMA</button>
      <div style="text-align:center;margin-top:4px;"><span onclick="openRecoverModal()" style="font-size:10px;color:var(--txt3);cursor:pointer;font-family:'DM Mono',monospace;text-transform:none;" onmouseover="this.style.color='var(--neon)'" onmouseout="this.style.color='var(--txt3)'">¬øOlvidaste tu contrase√±a?</span></div>
      <div class="l-loading" id="l-loading"><div class="l-spin"></div><div class="l-loading-txt">Verificando...</div></div>
    </div>
    <div id="quick-wrap" style="margin-top:18px;display:none;">
      <div class="l-div">acceso r√°pido</div>
      <div style="margin-top:9px;" id="quick-list"></div>
    </div>
  </div>
  <div id="form-register" style="display:none;">
    <div class="l-form">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;">
        <div class="l-field"><label>Nombre</label><input type="text" id="r-nombre" placeholder="Jhonatan"></div>
        <div class="l-field"><label>Apellido</label><input type="text" id="r-apellido" placeholder="Villanueva"></div>
      </div>
      <div class="l-field"><label>Email</label><input type="email" id="r-email" placeholder="tu@email.com"><span class="l-ico">@</span></div>
      <div class="l-field"><label>Usuario</label><input type="text" id="r-user" placeholder="admin"><span class="l-ico">‚óà</span></div>
      <div class="l-field"><label>Contrase√±a</label><input type="password" id="r-pass" placeholder="M√≠nimo 6 caracteres"><button class="l-tog" onclick="togglePass('r-pass',this)" type="button">üëÅ</button></div>
      <div class="l-field"><label>Confirmar</label><input type="password" id="r-pass2" placeholder="Repite" onkeydown="if(event.key==='Enter')doRegister()"><button class="l-tog" onclick="togglePass('r-pass2',this)" type="button">üëÅ</button></div>
      <div class="l-err" id="r-error">‚ö† Error</div>
      <div class="l-ok" id="r-success">‚úÖ Cuenta creada ‚Äî inicia sesi√≥n</div>
      <button class="btn-login" onclick="doRegister()">CREAR CUENTA</button>
    </div>
  </div>
  <div class="l-footer">Fibertel Center ¬∑ Sistema Empresarial 2026</div>
</div>
</div>

<!-- RECOVER -->
<div class="modal-overlay" id="modal-recover">
<div class="modal" style="max-width:390px;">
  <div class="modal-x" onclick="closeM('modal-recover')">‚úï</div>
  <div class="modal-title">Recuperar Acceso</div>
  <div class="modal-sub">Ingresa tu email para restablecer la contrase√±a</div>
  <div class="fg"><label>Email registrado</label><input type="email" id="rec-email" placeholder="tu@email.com"></div>
  <div class="l-err" id="rec-error" style="margin-top:7px;"></div>
  <div id="rec-ok" style="background:rgba(0,255,225,.06);border:1px solid rgba(0,255,225,.18);border-radius:9px;padding:8px 12px;font-size:11px;color:var(--neon);display:none;font-family:'DM Mono',monospace;margin-top:7px;"></div>
  <div id="rec-newpass-wrap" style="display:none;">
    <div class="fg" style="margin-top:9px;"><label>Nueva contrase√±a</label><input type="password" id="rec-newpass" placeholder="M√≠nimo 6 caracteres"></div>
    <div class="fg"><label>Confirmar contrase√±a</label><input type="password" id="rec-newpass2" placeholder="Repite"></div>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeM('modal-recover')">Cancelar</button>
    <button class="btn btn-neon" id="rec-btn" onclick="findRecoverUser()">Buscar cuenta</button>
  </div>
</div>
</div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-glow"></div>
<div class="logo-wrap">
  <div class="logo-badge"><div class="logo-icon">FC</div><div class="logo-name">Fibertel<span>Center</span></div></div>
  <div class="logo-sub">Sistema de Gesti√≥n ¬∑ 2026</div>
</div>
<div class="user-wrap" id="user-menu-wrap">
  <div class="user-card" onclick="toggleUserMenu()">
    <div class="uc-av" id="sb-avatar">JV</div>
    <div><div class="uc-name" id="sb-uname">Jhonatan V.</div><div class="uc-role">Administrador</div></div>
    <div class="uc-dot"></div>
  </div>
  <div class="udrop" id="user-dropdown">
    <div class="udrop-item" onclick="showProfileModal()"><span>üë§</span> Mi Perfil</div>
    <div class="udrop-sep"></div>
    <div class="udrop-item danger" onclick="doLogout()"><span>üö™</span> Cerrar Sesi√≥n</div>
  </div>
</div>
<nav>
  <span class="nsec">Principal</span>
  <div class="ni active" onclick="showPage('dashboard',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/></svg>
    Dashboard
  </div>
  <div class="ni" onclick="showPage('ventas',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    Ventas & Comisiones
    <span class="nbadge r" id="v-badge">0</span>
  </div>
  <span class="nsec">Gesti√≥n</span>
  <div class="ni" onclick="showPage('nomina',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
    N√≥mina & Sueldos
  </div>
  <span class="nsec">Riesgo & Control</span>
  <div class="ni" onclick="showPage('decomisiones',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    Decomisiones
    <span class="nbadge a" id="dc-badge">0</span>
  </div>
  <div class="ni" onclick="showPage('agentes',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
    Agentes
  </div>
  <div class="ni" onclick="showPage('gastos',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
    Gastos Operativos
  </div>
  <span class="nsec">Reportes & An√°lisis</span>
  <div class="ni" onclick="showPage('balance',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Balance Real
  </div>
  <div class="ni" onclick="showPage('analisis',this)">
    <span class="ni-ico">üß†</span>
    <span class="ni-txt">An√°lisis IA</span>
  </div>
  <div class="ni" onclick="showPage('educacion',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
    Educaci√≥n Financiera
    <span class="nbadge g">NEW</span>
  </div>
</nav>
<div class="sbot">
  <div class="gs-status">
    <div class="gs-status-lbl">Google Sheets</div>
    <div class="gs-status-val">
      <div class="gs-dot" id="gs-dot"></div>
      <span id="gs-status-txt">Sin conectar</span>
    </div>
  </div>
  <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;display:flex;margin-bottom:8px;" onclick="openM('modal-gs')">‚öô Configurar Sheets</button>
  <button class="btn btn-ghost btn-sm" style="width:100%;justify-content:center;display:flex;display:none;" id="btn-sync-now" onclick="syncNow()">üîÑ Sincronizar ahora</button>
  <div class="risk-box">
    <div class="risk-lbl">‚ö† Riesgo decomisi√≥n</div>
    <div class="risk-val" id="risk-total">S/ 0</div>
    <div class="risk-sub" id="risk-count">0 ventas &lt; 6 meses</div>
  </div>
</div>
</aside>

<!-- MAIN -->
<main class="main">

<!-- GLOBAL MONTH FILTER BAR -->
<div id="global-mes-bar" style="
  position:sticky;top:0;z-index:80;
  background:rgba(8,13,28,0.92);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--b1);
  display:flex;align-items:center;gap:12px;
  padding:10px 20px;margin:-20px -20px 18px;
  flex-wrap:wrap;">
  <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;white-space:nowrap;">üìÖ Per√≠odo:</div>
  <select id="global-mes" onchange="setGlobalMes(this.value)" style="
    padding:6px 12px;border-radius:9px;font-size:12px;
    background:var(--s2);border:1px solid var(--b2);color:var(--txt);
    font-family:'DM Sans',sans-serif;cursor:pointer;flex:1;max-width:220px;">
    <option value="">üìä Todos los meses (acumulado)</option>
  </select>
  <div id="global-mes-resumen" style="font-size:11px;color:var(--txt3);text-transform:none;letter-spacing:normal;font-family:'DM Sans',sans-serif;"></div>
</div>

<!-- DASHBOARD -->
<div class="page active" id="page-dashboard">
  <div class="ph">
    <div><div class="ph-eye">Panel de control</div><h2>Dashboard</h2><p>Visi√≥n general de Fibertel Center ¬∑ <span id="dash-fecha"></span></p></div>
    <div class="ph-acts">
      <button class="btn btn-ghost" onclick="openModalV()">+ Nueva venta</button>
      <button class="btn btn-neon" onclick="openModalG()">+ Gasto</button>
    </div>
  </div>
  <div class="metrics">
    <div class="mc m-g"><div class="mc-lbl">Comisiones cobradas</div><div class="mc-val" style="color:var(--neon)" id="d-com">S/ 0</div><div class="mc-sub">Total ingresos registrados</div><div class="mc-ico">üí∞</div></div>
    <div class="mc m-r"><div class="mc-lbl">Total egresos</div><div class="mc-val" style="color:var(--hot)" id="d-eg">S/ 0</div><div class="mc-sub">N√≥mina + gastos operativos</div><div class="mc-ico">üí∏</div></div>
    <div class="mc m-b"><div class="mc-lbl">Balance neto</div><div class="mc-val" id="d-bal">S/ 0</div><div class="mc-sub" id="d-bal-sub">Resultado real del negocio</div><div class="mc-ico">üìä</div></div>
    <div class="mc m-a"><div class="mc-lbl">Riesgo decomisi√≥n</div><div class="mc-val" style="color:var(--amber)" id="d-risk">S/ 0</div><div class="mc-sub">Ventas &lt; 6 meses activas</div><div class="mc-ico">‚ö†Ô∏è</div></div>
  </div>
  <div class="metrics-3">
    <div class="mc m-v"><div class="mc-lbl">Total ventas</div><div class="mc-val" style="color:var(--purple)" id="d-vs">0</div><div class="mc-sub">Contratos cerrados</div><div class="mc-ico">üìã</div></div>
    <div class="mc m-c"><div class="mc-lbl">Agentes activos</div><div class="mc-val" style="color:var(--cyan)" id="d-ag">0</div><div class="mc-sub">En equipo</div><div class="mc-ico">üë•</div></div>
    <div class="mc m-g"><div class="mc-lbl">Margen operativo</div><div class="mc-val" id="d-margen">0%</div><div class="mc-sub">Rentabilidad real</div><div class="mc-ico">üìà</div></div>
  </div>
  <!-- Sueldo sugerido -->
  <div class="card" style="margin-bottom:16px;border-color:rgba(0,255,225,0.12);background:rgba(0,255,225,0.02);">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:20px;flex-wrap:wrap;">
      <div>
        <div class="card-title">üíº Mi Sueldo Sugerido Este Mes</div>
        <div class="card-sub" style="margin-bottom:8px;">Calculado seg√∫n la Regla 30-20-50 sobre el balance real</div>
        <div style="font-family:'Bebas Neue',sans-serif;font-size:40px;letter-spacing:2px;color:var(--neon);line-height:1;" id="d-salary-main">S/ 0</div>
        <div style="font-size:11px;color:var(--txt2);margin-top:4px;text-transform:none;letter-spacing:normal;" id="d-salary-detail">Registra ventas y gastos para calcular</div>
      </div>
      <div class="salary-breakdown" style="min-width:320px;">
        <div class="sb-item"><div class="sb-lbl">Mi Sueldo (30%)</div><div class="sb-val" id="sb-30" style="color:var(--neon);">S/0</div></div>
        <div class="sb-item"><div class="sb-lbl">Reserva (20%)</div><div class="sb-val" id="sb-20" style="color:var(--gold);">S/0</div></div>
        <div class="sb-item"><div class="sb-lbl">Reinversi√≥n (50%)</div><div class="sb-val" id="sb-50" style="color:var(--purple);">S/0</div></div>
      </div>
    </div>
  </div>
  <div class="charts2">
    <div class="card"><div class="card-title">Flujo Mensual</div><div class="card-sub">// INGRESOS VS EGRESOS ¬∑ 6 MESES</div><canvas id="flowChart" height="185"></canvas></div>
    <div class="card"><div class="card-title">Composici√≥n Egresos</div><div class="card-sub">// N√ìMINA ¬∑ GASTOS ¬∑ DECOMISIONES</div><canvas id="egresoChart" height="185"></canvas></div>
  </div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">√öltimas Ventas</div><button class="btn btn-ghost btn-sm" onclick="showPage('ventas',document.querySelector('[onclick*=ventas]'))">Ver todas ‚Üí</button></div>
    <table><thead><tr><th>Fecha</th><th>Agente</th><th>Campa√±a</th><th>Producto</th><th>Comisi√≥n</th><th>Meses</th><th>Estado</th></tr></thead><tbody id="dash-table"></tbody></table>
  </div>
</div>

<!-- VENTAS -->
<div class="page" id="page-ventas">
  <div class="ph">
    <div><div class="ph-eye">Registro de ventas</div><h2>Ventas & Comisiones</h2><p>Contratos cerrados y comisiones cobradas</p></div>
    <div class="ph-acts"><button class="btn btn-neon" onclick="openModalV()">+ Nueva venta</button></div>
  </div>
  <div class="tcard">
    <div class="tbar">
      <div style="display:flex;gap:7px;flex-wrap:wrap;">
        <input style="width:160px;padding:6px 11px;border-radius:8px;font-size:11.5px;" type="text" placeholder="‚åï Buscar..." oninput="filterVentas(this.value)">
        <select style="padding:6px 11px;border-radius:8px;font-size:11.5px;" id="v-camp-filter" onchange="filterVentasCamp(this.value)"><option value="">Todas las campa√±as</option></select>
        <select style="padding:6px 11px;border-radius:8px;font-size:11.5px;" id="v-mes-filter" onchange="filterVentasMes(this.value)"><option value="">Todos los meses</option></select>
      </div>
      <div style="font-size:9px;color:var(--txt3);font-family:'DM Mono',monospace;" id="v-count">0 ventas</div>
    </div>
    <table><thead><tr><th>Fecha</th><th>Agente</th><th>Campa√±a</th><th>Producto</th><th>Cliente</th><th>Comisi√≥n</th><th>Meses activo</th><th>Estado</th><th></th></tr></thead><tbody id="v-table"></tbody></table>
  </div>
</div>

<!-- MODAL EDITAR VENTA -->
<div class="modal-overlay" id="modal-edit-venta">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">‚úèÔ∏è Editar Venta</div>
  <input type="hidden" id="ev-id">
  <div class="frow">
    <div class="fg"><label>Agente</label><select id="ev-agente"></select></div>
    <div class="fg"><label>Fecha</label><input type="date" id="ev-fecha"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Campa√±a</label><input type="text" id="ev-campana" placeholder="Internet / M√≥vil..."></div>
    <div class="fg"><label>Producto</label><input type="text" id="ev-producto" placeholder="Pack Fibra 100..."></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Cliente</label><input type="text" id="ev-cliente" placeholder="Nombre del cliente"></div>
    <div class="fg"><label>Comisi√≥n (S/)</label><input type="number" id="ev-comision" placeholder="0.00"></div>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="saveEditVenta()">Guardar cambios</button>
  </div>
</div>
</div>

<!-- N√ìMINA -->
<div class="page" id="page-nomina">
  <div class="ph">
    <div><div class="ph-eye">Gesti√≥n de personal</div><h2>N√≥mina & Sueldos</h2><p>Sueldos, comisiones y bonos del equipo</p></div>
    <div class="ph-acts" style="flex-wrap:wrap;gap:7px;">
      <select style="padding:6px 11px;border-radius:8px;font-size:11.5px;" id="nom-mes-filter" onchange="filterNominaMes(this.value)"><option value="">Todos los meses</option></select>
      <button class="btn btn-ghost" onclick="openModalP()">+ Registrar pago</button>
      <button class="btn btn-green" onclick="openModalB()">+ Bono</button>
      <button class="btn btn-hot" onclick="openModalDesc()">‚àí Descuento</button>
    </div>
  </div>
  <div class="charts2">
    <div class="card">
      <div class="card-title">Total a pagar</div><div class="card-sub">// SUELDOS + COMISIONES + BONOS</div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:34px;letter-spacing:2px;color:var(--hot);margin-bottom:7px;" id="nom-total">S/ 0</div>
      <div id="nom-breakdown"></div>
    </div>
    <div class="card"><div class="card-title">Distribuci√≥n</div><div class="card-sub">// POR TIPO DE PAGO</div><canvas id="nominaChart" height="170"></canvas></div>
  </div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">Detalle por Agente</div></div>
    <table><thead><tr><th>Agente</th><th>Sueldo base</th><th>Com. internet</th><th>Com. m√≥vil</th><th>Bonos</th><th>Adelantos</th><th style="color:var(--hot)">Descuentos</th><th style="color:var(--neon)">Total neto</th></tr></thead><tbody id="nom-table"></tbody></table>
  </div>
  <div class="tcard">
    <div class="tbar">
      <div class="tbar-title">Descuentos del Mes</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:9px;color:var(--hot);font-family:'DM Mono',monospace;" id="desc-total-lbl">Total: S/ 0</div>
        <button class="btn btn-hot btn-sm" onclick="openModalDesc()">‚àí Nuevo descuento</button>
      </div>
    </div>
    <table><thead><tr><th>Fecha</th><th>Agente</th><th>Tipo</th><th>Monto</th><th>Detalle</th><th></th></tr></thead><tbody id="desc-table"></tbody></table>
  </div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">Historial de Pagos</div></div>
    <table><thead><tr><th>Fecha</th><th>Agente</th><th>Tipo</th><th>Monto</th><th>Nota</th><th></th></tr></thead><tbody id="pagos-table"></tbody></table>
  </div>
</div>

<!-- DECOMISIONES -->
<div class="page" id="page-decomisiones">
  <div class="ph">
    <div><div class="ph-eye">Gesti√≥n de riesgo</div><h2>Decomisiones</h2><p>Ventas canceladas antes de 6 meses ‚Äî control de p√©rdidas</p></div>
    <div class="ph-acts"><button class="btn btn-amber" onclick="openModalDC()">‚ö† Registrar decomisi√≥n</button></div>
  </div>
  <div class="metrics-3">
    <div class="mc m-a"><div class="mc-lbl">En riesgo activo</div><div class="mc-val" style="color:var(--amber)" id="dc-riesgo">S/ 0</div><div class="mc-sub">Ventas &lt; 6 meses sin cancelar</div><div class="mc-ico">‚ö°</div></div>
    <div class="mc m-r"><div class="mc-lbl">Ya decomisionado</div><div class="mc-val" style="color:var(--hot)" id="dc-total">S/ 0</div><div class="mc-sub">Comisiones devueltas</div><div class="mc-ico">üíî</div></div>
    <div class="mc m-g"><div class="mc-lbl">Ventas consolidadas</div><div class="mc-val" style="color:var(--neon)" id="dc-safe">0</div><div class="mc-sub">Superaron los 6 meses ‚úì</div><div class="mc-ico">üõ°Ô∏è</div></div>
  </div>
  <div class="charts2">
    <div class="card"><div class="card-title">Riesgo por Mes de Venta</div><div class="card-sub">// EXPOSICI√ìN MENSUAL</div><canvas id="riskChart" height="195"></canvas></div>
    <div class="card"><div class="card-title">Riesgo por Agente</div><div class="card-sub">// COMISIONES EN RIESGO</div><div id="risk-by-agent" style="max-height:220px;overflow-y:auto;"></div></div>
  </div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">Historial de Decomisiones</div><div style="font-size:9px;color:var(--txt3);font-family:'DM Mono',monospace;" id="dc-count">0 registradas</div></div>
    <table><thead><tr><th>Fecha decomisi√≥n</th><th>Agente</th><th>Cliente</th><th>Meses activo</th><th>Comisi√≥n devuelta</th><th>Motivo</th><th></th></tr></thead><tbody id="dc-table"></tbody></table>
  </div>
</div>

<!-- AGENTES -->
<div class="page" id="page-agentes">
  <div class="ph">
    <div><div class="ph-eye">Equipo comercial</div><h2>Agentes</h2><p>Rendimiento y gesti√≥n del equipo de ventas</p></div>
    <div class="ph-acts"><button class="btn btn-neon" onclick="openModalAg()">+ Nuevo agente</button></div>
  </div>
  <div class="aperf" id="agent-cards"></div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">Ranking de Agentes</div></div>
    <table><thead><tr><th>#</th><th>Agente</th><th>Rol</th><th>Ventas</th><th>Com. generada</th><th>En riesgo</th><th>Decomisiones</th><th>Rendimiento/Sueldo</th><th></th></tr></thead><tbody id="ag-table"></tbody></table>
  </div>
</div>

<!-- GASTOS -->
<div class="page" id="page-gastos">
  <div class="ph">
    <div><div class="ph-eye">Control de egresos</div><h2>Gastos Operativos</h2><p>Gastos fuera de n√≥mina</p></div>
    <div class="ph-acts"><button class="btn btn-neon" onclick="openModalG()">+ Nuevo gasto</button></div>
  </div>
  <div class="charts2">
    <div class="card"><div class="card-title">Gastos por Categor√≠a</div><div class="card-sub">// DISTRIBUCI√ìN DE EGRESOS OPERATIVOS</div><canvas id="gastosChart" height="195"></canvas></div>
    <div class="card"><div class="card-title">Resumen por Categor√≠a</div><div class="card-sub">// TOTALES</div><div id="gastos-summary" style="max-height:220px;overflow-y:auto;"></div></div>
  </div>
  <div class="tcard">
    <div class="tbar"><div class="tbar-title">Historial de Gastos</div></div>
    <table><thead><tr><th>Fecha</th><th>Descripci√≥n</th><th>Categor√≠a</th><th>Monto</th><th></th></tr></thead><tbody id="g-table"></tbody></table>
  </div>
</div>

<!-- BALANCE -->
<div class="page" id="page-balance">
  <div class="ph">
    <div><div class="ph-eye">An√°lisis financiero</div><h2>Balance Real</h2><p>La realidad financiera de Fibertel Center</p></div>
  </div>
  <div class="metrics">
    <div class="mc m-g"><div class="mc-lbl">Ingresos totales</div><div class="mc-val" style="color:var(--neon)" id="bal-ing">S/ 0</div><div class="mc-sub">Comisiones cobradas</div><div class="mc-ico">üí∞</div></div>
    <div class="mc m-r"><div class="mc-lbl">Egresos totales</div><div class="mc-val" style="color:var(--hot)" id="bal-eg">S/ 0</div><div class="mc-sub">N√≥mina + operativos</div><div class="mc-ico">üí∏</div></div>
    <div class="mc m-b"><div class="mc-lbl">Beneficio bruto</div><div class="mc-val" id="bal-ben">S/ 0</div><div class="mc-sub">Antes de decomisiones</div><div class="mc-ico">üìä</div></div>
    <div class="mc m-a"><div class="mc-lbl">Beneficio ajustado</div><div class="mc-val" id="bal-adj">S/ 0</div><div class="mc-sub">Descontando riesgo real</div><div class="mc-ico">üéØ</div></div>
  </div>
  <div class="charts2">
    <div class="card"><div class="card-title">Evoluci√≥n Financiera</div><div class="card-sub">// 6 MESES DE HIST√ìRICO</div><canvas id="balanceChart" height="200"></canvas></div>
    <div class="card"><div class="card-title">P&L ‚Äî Estado de Resultados</div><div class="card-sub">// DESGLOSE COMPLETO</div><div id="pl-table" style="max-height:240px;overflow-y:auto;"></div></div>
  </div>
</div>

<!-- EDUCACI√ìN FINANCIERA -->

<!-- AN√ÅLISIS IA -->
<div class="page" id="page-analisis">
  <div class="ph">
    <div><div class="ph-eye">Inteligencia empresarial</div><h2>An√°lisis & Recomendaciones</h2><p>Comparativa mensual y plan de acci√≥n</p></div>
    <div class="ph-acts">
      <button class="btn btn-neon" onclick="renderAnalisis()">üîÑ Actualizar an√°lisis</button>
    </div>
  </div>

  <!-- COMPARATIVA MES ACTUAL vs ANTERIOR -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">üìä Comparativa: Este Mes vs Mes Anterior</div>
    <div class="card-sub">// RENDIMIENTO RELATIVO</div>
    <div id="analisis-comparativa" style="margin-top:12px;"></div>
  </div>

  <!-- KPIs DEL MES -->
  <div class="metrics" style="margin-bottom:16px;" id="analisis-kpis"></div>

  <!-- SALUD DEL NEGOCIO -->
  <div class="card" style="margin-bottom:16px;">
    <div class="card-title">üè• Salud del Negocio</div>
    <div class="card-sub">// DIAGN√ìSTICO ACTUAL</div>
    <div id="analisis-salud" style="margin-top:12px;"></div>
  </div>

  <!-- RECOMENDACIONES -->
  <div class="card">
    <div class="card-title">üéØ Plan de Acci√≥n Recomendado</div>
    <div class="card-sub">// MEJORAS PRIORIZADAS SEG√öN TUS DATOS</div>
    <div id="analisis-recs" style="margin-top:12px;"></div>
  </div>
</div>

<div class="page" id="page-educacion">
  <div class="ph">
    <div><div class="ph-eye">An√°lisis y educaci√≥n</div><h2>Educaci√≥n Financiera</h2><p>Conceptos y calculadoras basadas en los datos reales de Fibertel Center</p></div>
  </div>

  <!-- Calculadora sueldo destacada -->
  <div class="card" style="margin-bottom:16px;border-color:rgba(0,255,225,0.2);background:rgba(0,255,225,0.02);">
    <div class="card-title">üßÆ Calculadora de Sueldo del Due√±o</div>
    <div class="card-sub" style="margin-bottom:16px;">¬øCu√°nto deber√≠a pagarme? Calculado con tus datos reales usando la Regla 30-20-50</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;align-items:start;">
      <div>
        <div style="margin-bottom:10px;">
          <div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:5px;">Ingresos del mes (S/)</div>
          <input type="number" id="sal-ing-input" placeholder="Ingresa o usa datos reales" oninput="calcSalary()" style="margin:0;">
        </div>
        <div style="margin-bottom:10px;">
          <div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:5px;">Egresos del mes (S/)</div>
          <input type="number" id="sal-eg-input" placeholder="Gastos + sueldos del equipo" oninput="calcSalary()" style="margin:0;">
        </div>
        <button class="btn btn-neon btn-sm" onclick="loadRealDataToCalc()" style="width:100%;margin-top:4px;">üìä Usar datos reales del sistema</button>
      </div>
      <div id="salary-result">
        <div style="background:rgba(0,255,225,0.04);border:1px solid rgba(0,255,225,0.15);border-radius:12px;padding:16px;text-align:center;">
          <div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:6px;">Mi sueldo sugerido</div>
          <div style="font-family:'Bebas Neue',sans-serif;font-size:44px;letter-spacing:2px;color:var(--neon);line-height:1;" id="sal-result-main">S/ 0</div>
          <div style="font-size:10px;color:var(--txt2);margin-top:4px;text-transform:none;letter-spacing:normal;" id="sal-result-pct">30% del balance neto</div>
        </div>
        <div class="salary-breakdown" style="margin-top:10px;">
          <div class="sb-item"><div class="sb-lbl">Tu sueldo (30%)</div><div class="sb-val" id="sal-r30" style="color:var(--neon);">S/0</div></div>
          <div class="sb-item"><div class="sb-lbl">Reserva (20%)</div><div class="sb-val" id="sal-r20" style="color:var(--gold);">S/0</div></div>
          <div class="sb-item"><div class="sb-lbl">Reinversi√≥n (50%)</div><div class="sb-val" id="sal-r50" style="color:var(--purple);">S/0</div></div>
        </div>
      </div>
    </div>
    <div id="sal-alert" style="display:none;margin-top:12px;background:rgba(255,45,110,0.06);border:1px solid rgba(255,45,110,0.2);border-radius:9px;padding:10px 14px;font-size:11.5px;color:var(--hot);text-transform:none;letter-spacing:normal;"></div>
  </div>

  <div class="edu-grid">
    <div class="edu-card">
      <div class="edu-tag">üìä Indicadores Clave</div>
      <div class="edu-title">Margen de Rentabilidad</div>
      <div class="edu-desc">El margen operativo mide qu√© porcentaje de tus ingresos se convierte en ganancia real despu√©s de pagar todos los gastos. Para un call center el objetivo es m√≠nimo 20-35%.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Tu margen actual</div>
        <div class="edu-result" id="edu-margen">Registra datos para calcular</div>
      </div>
    </div>

    <div class="edu-card">
      <div class="edu-tag">üí∏ Gesti√≥n de Riesgo</div>
      <div class="edu-title">Fondo Anti-Decomisiones</div>
      <div class="edu-desc">Dado que las ventas pueden decomisionar hasta 6 meses despu√©s, deber√≠as mantener una reserva del 20% de tus comisiones mensuales para absorber esas p√©rdidas sin afectar tu operaci√≥n.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Reserva recomendada</div>
        <div class="edu-result" id="edu-reserva">Registra datos para calcular</div>
      </div>
    </div>

    <div class="edu-card">
      <div class="edu-tag">üìà Crecimiento</div>
      <div class="edu-title">Punto de Equilibrio</div>
      <div class="edu-desc">El punto de equilibrio es el ingreso m√≠nimo que necesitas para cubrir todos los costos fijos (sueldos + gastos operativos). Todo lo que superes ese umbral es ganancia real.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Tu punto de equilibrio</div>
        <div class="edu-result" id="edu-equilibrio">Registra datos para calcular</div>
      </div>
    </div>

    <div class="edu-card">
      <div class="edu-tag">‚ö° Eficiencia</div>
      <div class="edu-title">Costo por Venta (CPV)</div>
      <div class="edu-desc">El CPV mide cu√°nto te cuesta operar el call center por cada venta cerrada. Mantener el CPV menor que la comisi√≥n promedio por venta es cr√≠tico para la rentabilidad.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Tu CPV actual</div>
        <div class="edu-result" id="edu-cpv">Registra datos para calcular</div>
      </div>
    </div>

    <div class="edu-card">
      <div class="edu-tag">üèÜ Incentivos</div>
      <div class="edu-title">Estructura de Bonos</div>
      <div class="edu-desc">Los mejores call centers usan esquemas escalonados: bono base por metas m√≠nimas, bono premium por superaci√≥n y bono de equipo para fomentar colaboraci√≥n.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Simulador de bonos</div>
        <input type="number" id="bono-ventas" placeholder="Cantidad de ventas del mes" oninput="calcBonos()">
        <div class="edu-result" id="edu-bono">Ingresa las ventas para simular</div>
      </div>
    </div>

    <div class="edu-card">
      <div class="edu-tag">üìÖ Proyecci√≥n</div>
      <div class="edu-title">¬øA este ritmo cu√°ndo llegas?</div>
      <div class="edu-desc">Con base en tu promedio mensual actual, esta herramienta te muestra cu√°ndo podr√≠as alcanzar distintos objetivos financieros para Fibertel Center.</div>
      <div class="edu-calc">
        <div class="edu-calc-title">Proyecci√≥n basada en datos reales</div>
        <input type="number" id="proyeccion-meta" placeholder="Meta de ingresos (S/)" oninput="calcProyeccion()">
        <div class="edu-result" id="edu-proyeccion">Ingresa una meta para proyectar</div>
      </div>
    </div>
  </div>
</div>

</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- MODAL VENTA -->
<div class="modal-overlay" id="modal-venta">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">üìã Nueva Venta</div>
  <div class="modal-sub">Registra un contrato cerrado y la comisi√≥n correspondiente</div>
  <div class="frow">
    <div class="fg"><label>Agente</label><select id="v-agente"></select></div>
    <div class="fg"><label>Fecha de venta</label><input type="date" id="v-fecha"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Campa√±a / Operador</label><input type="text" id="v-camp" placeholder="Ej: Movistar, Claro..."></div>
    <div class="fg"><label>Producto</label>
      <select id="v-producto">
        <option value="Fibra">üì° Fibra √≥ptica / Internet</option>
        <option value="M√≥vil">üì± M√≥vil</option>
        <option value="TV">üì∫ Televisi√≥n</option>
        <option value="Combinado">üì¶ Paquete combinado</option>
      </select>
    </div>
  </div>
  <div class="frow">
    <div class="fg"><label>Referencia cliente</label><input type="text" id="v-cliente" placeholder="Nombre o ID"></div>
    <div class="fg"><label>Comisi√≥n bruta (S/)</label><input type="number" id="v-comision" placeholder="0.00" step="0.01"></div>
  </div>
  <div class="fg"><label>Notas</label><input type="text" id="v-nota" placeholder="Observaciones"></div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="saveVenta()">Guardar venta</button>
  </div>
</div>
</div>

<!-- MODAL GASTO -->
<div class="modal-overlay" id="modal-gasto">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">üí∏ Gasto Operativo</div>
  <div class="modal-sub">Registra un egreso de la empresa (excluye sueldos/comisiones)</div>
  <div class="frow">
    <div class="fg"><label>Fecha</label><input type="date" id="g-fecha"></div>
    <div class="fg"><label>Monto (S/)</label><input type="number" id="g-monto" placeholder="0.00" step="0.01"></div>
  </div>
  <div class="fg"><label>Descripci√≥n</label><input type="text" id="g-desc" placeholder="Ej: Alquiler oficina, internet..."></div>
  <div class="fg"><label>Categor√≠a</label>
    <div style="display:flex;gap:8px;align-items:center;">
      <select id="g-cat" style="flex:1;"></select>
      <button type="button" class="btn btn-ghost btn-sm" onclick="addCatGasto()" title="Nueva categor√≠a" style="padding:7px 10px;white-space:nowrap;">+ Cat.</button>
    </div>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="saveGasto()">Guardar gasto</button>
  </div>
</div>
</div>

<!-- MODAL AGENTE -->
<div class="modal-overlay" id="modal-agente">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">üë§ Nuevo Agente</div>
  <div class="modal-sub">Agrega un miembro al equipo</div>
  <div class="frow">
    <div class="fg"><label>Nombre completo</label><input type="text" id="ag-nombre" placeholder="Nombre completo"></div>
    <div class="fg"><label>Fecha de inicio</label><input type="date" id="ag-inicio"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Rol en el equipo</label>
      <select id="ag-rol" onchange="updateRolInfo()">
        <option value="Comercial">üíº Comercial ‚Äî genera ventas</option>
        <option value="BackOffice">üñ•Ô∏è BackOffice ‚Äî soporte interno</option>
        <option value="Supervisor">üëë Supervisor ‚Äî gesti√≥n del equipo</option>
      </select>
    </div>
    <div class="fg"><label>Meta ventas/mes</label><input type="number" id="ag-meta" placeholder="20"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Sueldo base (S/)</label><input type="number" id="ag-sueldo" placeholder="1200"></div>
    <div class="fg" id="ag-com-wrap">
      <label>Com. por internet (S/venta)</label><input type="number" id="ag-com-int" placeholder="20">
    </div>
  </div>
  <div class="frow" id="ag-com-row2">
    <div class="fg"><label>Com. por m√≥vil (S/venta)</label><input type="number" id="ag-com-mov" placeholder="15"></div>
    <div class="fg"></div>
  </div>
  <div style="background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:10px 13px;font-size:11px;color:var(--txt2);text-transform:none;letter-spacing:normal;line-height:1.6;margin-bottom:8px;" id="ag-rol-info">
    üíº <strong>Comercial:</strong> aparece en el selector de ventas. Sus comisiones son el ingreso del negocio.
  </div>
  <div class="fg"><label>Color identificador</label>
    <div style="display:flex;gap:7px;margin-top:4px;" id="ag-colpick">
      <div onclick="pickC('#00ffe1',this)" style="width:22px;height:22px;border-radius:50%;background:#00ffe1;cursor:pointer;border:2px solid #fff;"></div>
      <div onclick="pickC('#10e89a',this)" style="width:22px;height:22px;border-radius:50%;background:#10e89a;cursor:pointer;"></div>
      <div onclick="pickC('#f5c842',this)" style="width:22px;height:22px;border-radius:50%;background:#f5c842;cursor:pointer;"></div>
      <div onclick="pickC('#ff2d6e',this)" style="width:22px;height:22px;border-radius:50%;background:#ff2d6e;cursor:pointer;"></div>
      <div onclick="pickC('#b06aff',this)" style="width:22px;height:22px;border-radius:50%;background:#b06aff;cursor:pointer;"></div>
      <div onclick="pickC('#4da6ff',this)" style="width:22px;height:22px;border-radius:50%;background:#4da6ff;cursor:pointer;"></div>
    </div>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="saveAgente()">Agregar agente</button>
  </div>
</div>
</div>

<!-- MODAL EDITAR AGENTE -->
<div class="modal-overlay" id="modal-edit-agente">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">‚úèÔ∏è Editar Agente</div>
  <input type="hidden" id="eag-id">
  <div class="frow">
    <div class="fg"><label>Nombre completo</label><input type="text" id="eag-nombre" placeholder="Nombre completo"></div>
    <div class="fg"><label>Fecha de inicio</label><input type="date" id="eag-inicio"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Rol en el equipo</label>
      <select id="eag-rol" onchange="updateEditRolInfo()">
        <option value="Comercial">üíº Comercial ‚Äî genera ventas</option>
        <option value="BackOffice">üñ•Ô∏è BackOffice ‚Äî soporte interno</option>
        <option value="Supervisor">üëë Supervisor ‚Äî gesti√≥n del equipo</option>
      </select>
    </div>
    <div class="fg"><label>Meta ventas/mes</label><input type="number" id="eag-meta" placeholder="20"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Sueldo base (S/)</label><input type="number" id="eag-sueldo" placeholder="1200"></div>
    <div class="fg"><label>Com. por internet (S/venta)</label><input type="number" id="eag-com-int" placeholder="20"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Com. por m√≥vil (S/venta)</label><input type="number" id="eag-com-mov" placeholder="15"></div>
    <div class="fg"></div>
  </div>
  <div style="background:var(--s2);border:1px solid var(--b1);border-radius:10px;padding:10px 13px;font-size:11px;color:var(--txt2);text-transform:none;letter-spacing:normal;line-height:1.6;margin-bottom:8px;" id="eag-rol-info"></div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="saveEditAgente()">Guardar cambios</button>
  </div>
</div>
</div>
<div class="modal-overlay" id="modal-pago">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">üíº Registrar Pago</div>
  <div class="modal-sub">Registra el pago de sueldo, comisi√≥n o bono a un agente</div>
  <div class="frow">
    <div class="fg"><label>Agente</label><select id="p-agente"></select></div>
    <div class="fg"><label>Fecha</label><input type="date" id="p-fecha"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Tipo de pago</label>
      <select id="p-tipo">
        <option value="Sueldo base">Sueldo base</option>
        <option value="Comisi√≥n internet">Comisi√≥n internet</option>
        <option value="Comisi√≥n m√≥vil">Comisi√≥n m√≥vil</option>
        <option value="Bono especial">Bono especial</option>
        <option value="Adelanto">Adelanto</option>
      </select>
    </div>
    <div class="fg"><label>Monto (S/)</label><input type="number" id="p-monto" placeholder="0.00" step="0.01"></div>
  </div>
  <div class="fg"><label>Notas</label><input type="text" id="p-nota" placeholder="Referencia del pago"></div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-neon" onclick="savePago()">Registrar pago</button>
  </div>
</div>
</div>

<!-- MODAL BONO -->
<div class="modal-overlay" id="modal-bono">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">üéÅ Agregar Bono</div>
  <div class="modal-sub">Asigna un bono por rendimiento o meta alcanzada</div>
  <div class="frow">
    <div class="fg"><label>Agente</label><select id="b-agente"></select></div>
    <div class="fg"><label>Fecha del bono</label><input type="date" id="b-fecha"></div>
  </div>
  <div class="frow">
    <div class="fg"><label>Monto bono (S/)</label><input type="number" id="b-monto" placeholder="0.00"></div>
    <div class="fg"><label>Mes al que corresponde</label>
      <select id="b-mes-ref" style="width:100%;">
        <option value="">Este mes</option>
      </select>
    </div>
  </div>
  <div class="fg"><label>Motivo</label><input type="text" id="b-motivo" placeholder="Ej: Mejor vendedor del mes..."></div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-green" onclick="saveBono()">Asignar bono</button>
  </div>
</div>
</div>

<!-- MODAL DESCUENTO -->
<div class="modal-overlay" id="modal-descuento">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title" style="color:var(--hot);">‚àí Registrar Descuento</div>
  <div class="modal-sub">Descuentos por faltas, tardanzas, decomisiones u otros motivos</div>
  <div class="frow">
    <div class="fg"><label>Agente</label><select id="desc-agente"></select></div>
    <div class="fg"><label>Fecha del descuento</label><input type="date" id="desc-fecha"></div>
  </div>
  <div class="fg"><label>Mes al que corresponde</label>
    <select id="desc-mes-ref" style="width:100%;"></select>
  </div>
  <div class="fg"><label>Tipo de descuento</label>
    <select id="desc-tipo" onchange="updateDescPlaceholder()">
      <option value="Falta injustificada">‚ùå Falta injustificada</option>
      <option value="Tardanza">‚è∞ Tardanza</option>
      <option value="Decomisi√≥n descontada">üìâ Decomisi√≥n descontada</option>
      <option value="Pr√©stamo / Adelanto">üíµ Pr√©stamo / Adelanto</option>
      <option value="Error operativo">‚ö†Ô∏è Error operativo</option>
      <option value="Otro">üìã Otro</option>
    </select>
  </div>
  <div class="frow">
    <div class="fg"><label>Monto a descontar (S/)</label><input type="number" id="desc-monto" placeholder="0.00" step="0.01"></div>
    <div class="fg"><label>Cantidad <span id="desc-cant-lbl" style="color:var(--txt3);font-size:9px;">(faltas / minutos)</span></label><input type="number" id="desc-cant" placeholder="1" min="1"></div>
  </div>
  <div class="fg"><label>Detalle / Observaci√≥n</label><input type="text" id="desc-detalle" placeholder="Ej: Falta del lunes 12/02, sin aviso"></div>
  <!-- Calculadora r√°pida -->
  <div style="background:var(--s2);border:1px solid var(--b1);border-radius:11px;padding:12px;margin-top:4px;">
    <div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:8px;">Calculadora r√°pida</div>
    <div class="frow">
      <div class="fg" style="margin:0;"><label>Sueldo diario (S/)</label><input type="number" id="calc-diario" placeholder="Ej: 60" oninput="calcDescuento()"></div>
      <div class="fg" style="margin:0;"><label>D√≠as / Minutos</label><input type="number" id="calc-cant" placeholder="1" oninput="calcDescuento()"></div>
    </div>
    <div id="calc-result" style="margin-top:8px;font-family:'DM Mono',monospace;font-size:11px;color:var(--neon);display:none;padding:6px 10px;background:rgba(0,255,225,0.05);border-radius:7px;"></div>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-hot" onclick="saveDescuento()">Registrar descuento</button>
  </div>
</div>
</div>

<!-- MODAL DECOMISI√ìN -->
<div class="modal-overlay" id="modal-decomision">
<div class="modal">
  <div class="modal-x" onclick="closeModals()">‚úï</div>
  <div class="modal-title">‚ö†Ô∏è Registrar Decomisi√≥n</div>
  <div class="modal-sub">Un cliente se desconect√≥ antes de los 6 meses</div>
  <div class="fg"><label>Venta afectada</label><select id="dc-venta"></select></div>
  <div class="frow">
    <div class="fg"><label>Fecha desconexi√≥n</label><input type="date" id="dc-fecha"></div>
    <div class="fg"><label>Monto a devolver (S/)</label><input type="number" id="dc-monto" placeholder="Comisi√≥n a descontar"></div>
  </div>
  <div class="fg"><label>Motivo</label>
    <select id="dc-motivo">
      <option value="Cliente cancel√≥ contrato">Cliente cancel√≥ contrato</option>
      <option value="Portabilidad del cliente">Portabilidad</option>
      <option value="Error en instalaci√≥n">Error en instalaci√≥n</option>
      <option value="Impago del cliente">Impago del cliente</option>
      <option value="Otro">Otro</option>
    </select>
  </div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeModals()">Cancelar</button>
    <button class="btn btn-amber" onclick="saveDecomision()">Registrar decomisi√≥n</button>
  </div>
</div>
</div>

<!-- MODAL PERFIL -->
<div class="modal-overlay" id="modal-profile">
<div class="modal" style="max-width:400px;">
  <div class="modal-x" onclick="closeM('modal-profile')">‚úï</div>
  <div class="modal-title">üë§ Mi Perfil</div>
  <div class="modal-sub">Actualiza tu informaci√≥n de acceso</div>
  <div class="fg"><label>Nombre completo</label><input type="text" id="pf-fullname"></div>
  <div class="fg"><label>Nueva contrase√±a (vac√≠o = no cambiar)</label><input type="password" id="pf-newpass" placeholder="Nueva contrase√±a"></div>
  <div class="fg"><label>Confirmar nueva contrase√±a</label><input type="password" id="pf-newpass2" placeholder="Confirmar"></div>
  <div class="l-err" id="pf-error" style="margin-top:7px;"></div>
  <div class="l-ok" id="pf-success" style="margin-top:7px;">‚úÖ Perfil actualizado</div>
  <div class="macts">
    <button class="btn btn-ghost" onclick="closeM('modal-profile')">Cancelar</button>
    <button class="btn btn-neon" onclick="saveProfile()">Guardar</button>
  </div>
</div>
</div>

<!-- MODAL GOOGLE SHEETS -->
<div class="modal-overlay" id="modal-gs">
<div class="modal modal-wide">
  <div class="modal-x" onclick="closeM('modal-gs')">‚úï</div>
  <div class="modal-title">‚òÅÔ∏è Google Sheets</div>
  <div class="modal-sub">Conecta tu Google Sheets para guardar todos los datos en la nube. Sheets act√∫a como tu base de datos.</div>

  <div style="background:var(--s2);border:1px solid var(--b1);border-radius:14px;padding:18px;margin-bottom:16px;">
    <div style="font-size:8px;letter-spacing:2.5px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:12px;">Pasos de configuraci√≥n</div>
    <div class="gs-step"><span class="gs-step-num">01</span> Abre Google Sheets, crea un nuevo documento y guarda el ID de la URL (la parte larga entre /d/ y /edit)</div>
    <div class="gs-step"><span class="gs-step-num">02</span> En el mismo Sheets, ve a Extensiones ‚Üí Apps Script y borra todo el contenido del editor</div>
    <div class="gs-step"><span class="gs-step-num">03</span> Haz clic en "Ver c√≥digo Apps Script" y copia todo el c√≥digo</div>
    <div class="gs-step"><span class="gs-step-num">04</span> Pega el c√≥digo en el editor, reemplaza TU_SPREADSHEET_ID por tu ID real, y guarda (Ctrl+S)</div>
    <div class="gs-step"><span class="gs-step-num">05</span> Clic en "Implementar" ‚Üí "Nueva implementaci√≥n" ‚Üí Tipo: Aplicaci√≥n web ‚Üí Acceso: Cualquier persona ‚Üí Implementar</div>
    <div class="gs-step" style="border:none;"><span class="gs-step-num">06</span> Copia la URL de implementaci√≥n, p√©gala abajo y haz clic en "Conectar y probar"</div>
  </div>

  <div class="fg" style="margin-bottom:10px;">
    <label>URL del Apps Script (implementaci√≥n)</label>
    <input type="url" id="gs-url-input" placeholder="https://script.google.com/macros/s/AKfy.../exec">
  </div>
  <div id="gs-err" style="background:rgba(255,45,110,.07);border:1px solid rgba(255,45,110,.2);border-radius:9px;padding:9px 13px;font-size:11px;color:var(--hot);display:none;margin-bottom:10px;text-transform:none;letter-spacing:normal;"></div>
  <div id="gs-ok" style="background:rgba(0,255,225,.05);border:1px solid rgba(0,255,225,.2);border-radius:9px;padding:9px 13px;font-size:11px;color:var(--neon);display:none;margin-bottom:10px;text-transform:none;letter-spacing:normal;">‚úÖ Conexi√≥n exitosa. Sincronizando datos...</div>

  <div style="display:flex;gap:9px;align-items:center;margin-bottom:10px;" id="gs-connected-row" style="display:none;">
    <div style="font-size:10px;color:var(--txt3);font-family:'DM Mono',monospace;">Conectado:</div>
    <div style="font-size:11px;color:var(--neon);font-family:'DM Mono',monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;" id="gs-url-short"></div>
    <button class="btn btn-hot btn-sm" onclick="disconnectSheets()">Desconectar</button>
  </div>

  <div class="macts">
    <button class="btn btn-ghost" onclick="showGSScript()">üìã Ver c√≥digo Apps Script</button>
    <button class="btn btn-ghost" onclick="closeM('modal-gs')">Cancelar</button>
    <button class="btn btn-neon" onclick="connectSheets()">Conectar y probar</button>
  </div>
  <!-- Acciones manuales (visible solo si ya est√° conectado) -->
  <div id="gs-manual-actions" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--b1);">
    <div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--txt3);font-family:'DM Mono',monospace;margin-bottom:10px;">Sincronizaci√≥n manual</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <button class="btn btn-ghost" onclick="forcePullFromSheets();closeM('modal-gs');" style="display:flex;align-items:center;gap:7px;justify-content:center;">
        ‚¨áÔ∏è <div style="text-align:left;"><div style="font-size:11px;">Bajar de Sheets</div><div style="font-size:9px;font-weight:400;color:var(--txt3);text-transform:none;">Sheets ‚Üí este dispositivo</div></div>
      </button>
      <button class="btn btn-ghost" onclick="forcePushToSheets();closeM('modal-gs');" style="display:flex;align-items:center;gap:7px;justify-content:center;">
        ‚¨ÜÔ∏è <div style="text-align:left;"><div style="font-size:11px;">Subir a Sheets</div><div style="font-size:9px;font-weight:400;color:var(--txt3);text-transform:none;">Este dispositivo ‚Üí Sheets</div></div>
      </button>
    </div>
  </div>
</div>
</div>

<!-- MODAL GS SCRIPT -->
<div class="modal-overlay" id="modal-gs-script">
<div class="modal modal-wide">
  <div class="modal-x" onclick="closeM('modal-gs-script')">‚úï</div>
  <div class="modal-title">C√≥digo Google Apps Script</div>
  <div class="modal-sub">Copia todo este c√≥digo y p√©galo en tu Google Apps Script</div>
  <div class="code-block"><pre id="gs-code-content"></pre></div>
  <div class="macts">
    <button class="btn btn-neon" onclick="copyGSCode()">üìã Copiar c√≥digo</button>
    <button class="btn btn-ghost" onclick="closeM('modal-gs-script')">Cerrar</button>
  </div>
</div>
</div>

<div id="toast-wrap"></div>

<!-- PWA INSTALL BUTTON -->
<div id="pwa-banner" style="display:none;position:fixed;bottom:80px;right:22px;z-index:8000;">
  <button onclick="installPWA()" style="
    background:linear-gradient(135deg,#00ffe1,#4da6ff);
    color:#04060f;border:none;border-radius:14px;
    padding:12px 20px;font-family:'DM Sans',sans-serif;
    font-size:13px;font-weight:700;cursor:pointer;
    box-shadow:0 0 30px rgba(0,255,225,0.4),0 8px 25px rgba(0,0,0,0.5);
    display:flex;align-items:center;gap:9px;letter-spacing:.3px;
    animation:pwaBounce 2s ease-in-out infinite;">
    <span style="font-size:18px;">üì≤</span>
    <div style="text-align:left;">
      <div>Instalar en Android</div>
      <div style="font-size:10px;font-weight:400;opacity:.8;">Gratis ¬∑ Sin Play Store</div>
    </div>
  </button>
</div>
<style>
@keyframes pwaBounce{0%,100%{transform:translateY(0);}50%{transform:translateY(-5px);}}
</style>

<script>
/* ‚ïê‚ïê SERVICE WORKER ‚Äî se registra desde sw.js ‚ïê‚ïê
   Si est√°s en GitHub Pages, el archivo sw.js debe
   estar en la ra√≠z del repositorio junto a index.html.
   Este c√≥digo lo registra autom√°ticamente. ‚ïê‚ïê */
if('serviceWorker' in navigator){
  // Solo intentar si estamos en http/https (no en file://)
  if(location.protocol === 'https:' || location.hostname === 'localhost'){
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('‚úÖ SW registrado:', reg.scope))
      .catch(err => console.log('‚ÑπÔ∏è SW no disponible (normal en primera carga):', err.message));
  }
}

/* ‚ïê‚ïê PWA INSTALL PROMPT ‚ïê‚ïê */
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('pwa-banner').style.display = 'block';
});
window.addEventListener('appinstalled', () => {
  document.getElementById('pwa-banner').style.display = 'none';
  deferredPrompt = null;
  toast('üéâ ¬°App instalada en tu Android!', 'ok');
});
function installPWA(){
  if(!deferredPrompt){ toast('üí° En Chrome: men√∫ ‚ãÆ ‚Üí "A√±adir a pantalla de inicio"'); return; }
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(r => {
    if(r.outcome === 'accepted') toast('‚úÖ Instalando Fibertel Center...', 'ok');
    deferredPrompt = null;
    document.getElementById('pwa-banner').style.display = 'none';
  });
}

/* ‚ïê‚ïê CHECK: si viene de ?page= abrir esa secci√≥n ‚ïê‚ïê */
window.addEventListener('DOMContentLoaded', ()=>{
  const params = new URLSearchParams(window.location.search);
  const page = params.get('page');
  if(page && document.getElementById('page-'+page)){
    setTimeout(()=>showPage(page), 100);
  }
});
</script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FIBERTEL CENTER ‚Äî Sistema de Gesti√≥n Empresarial 2026
   Dise√±o ultra-moderno + Google Sheets como base de datos
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ ANIMATED BACKGROUND ‚îÄ‚îÄ‚îÄ */
(function(){
  const canvas = document.getElementById('bgCanvas');
  const ctx = canvas.getContext('2d');
  let W,H,particles=[],stars=[],ripples=[],frame=0,mx=0,my=0;
  const COLORS=['rgba(0,255,225,1)','rgba(255,45,110,1)','rgba(176,106,255,1)','rgba(200,255,0,1)','rgba(77,166,255,1)'];
  const CHARS='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ+-=/><!@#$%&*';
  let rainCols=[];
  const rnd=(a,b)=>a+Math.random()*(b-a);

  function initRain(){
    rainCols=[];
    const cols=Math.floor(W/24);
    for(let i=0;i<cols;i++) rainCols.push({x:i*24+rnd(0,10),y:rnd(-H,0),speed:rnd(1,3),chars:Array.from({length:Math.floor(rnd(8,18))},()=>CHARS[Math.floor(Math.random()*CHARS.length)]),color:COLORS[Math.floor(Math.random()*COLORS.length)].replace('1)','0.3)'),alpha:rnd(0.07,0.25)});
  }
  function resize(){
    W=canvas.width=window.innerWidth;H=canvas.height=window.innerHeight;
    particles=[];
    for(let i=0;i<40;i++) particles.push({x:Math.random(),y:Math.random(),vx:(Math.random()-.5)*0.0016,vy:(Math.random()-.5)*0.0016,r:rnd(1.2,3.5),color:COLORS[Math.floor(Math.random()*COLORS.length)],alpha:rnd(0.2,0.55),pulse:Math.random()*Math.PI*2,pspd:rnd(0.02,0.05),trail:[]});
    initRain();
  }
  canvas.addEventListener('click',e=>ripples.push({x:e.clientX,y:e.clientY,r:0,alpha:.5}));
  document.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;});
  function spawnStar(){stars.push({x:rnd(-.1,0),y:rnd(0,.35),vx:rnd(.004,.008),vy:rnd(.001,.003),len:rnd(.06,.11),life:1,color:COLORS[Math.floor(Math.random()*COLORS.length)]});}

  function draw(){
    ctx.clearRect(0,0,W,H);frame++;
    // Data rain
    if(frame%2===0){
      ctx.font='11px "DM Mono",monospace';
      rainCols.forEach(col=>{
        col.chars.forEach((ch,i)=>{const yy=col.y+i*16;if(yy>0&&yy<H+16){if(i===0){ctx.fillStyle='#fff';ctx.globalAlpha=col.alpha*2.2;}else{ctx.fillStyle=col.color;ctx.globalAlpha=col.alpha*(1-i/col.chars.length*0.8);}ctx.fillText(ch,col.x,yy);}});
        col.y+=col.speed;if(col.y>H+80){col.y=rnd(-H*.4,-20);col.chars=col.chars.map(()=>CHARS[Math.floor(Math.random()*CHARS.length)]);col.speed=rnd(1,3);}
        if(Math.random()<.02){const idx=Math.floor(Math.random()*col.chars.length);col.chars[idx]=CHARS[Math.floor(Math.random()*CHARS.length)];}
      });ctx.globalAlpha=1;
    }
    // Particle network
    for(let i=0;i<particles.length;i++){for(let j=i+1;j<particles.length;j++){const p=particles[i],q=particles[j];const dx=(p.x-q.x)*W,dy=(p.y-q.y)*H,d=Math.sqrt(dx*dx+dy*dy);if(d<120){ctx.globalAlpha=(1-d/120)*0.09;ctx.strokeStyle=p.color;ctx.lineWidth=.4;ctx.beginPath();ctx.moveTo(p.x*W,p.y*H);ctx.lineTo(q.x*W,q.y*H);ctx.stroke();}}}
    ctx.globalAlpha=1;
    // Particles
    particles.forEach(p=>{
      p.pulse+=p.pspd;p.trail.push({x:p.x*W,y:p.y*H});if(p.trail.length>6)p.trail.shift();
      p.trail.forEach((pt,i)=>{const ta=Math.max(0,p.alpha*(i/p.trail.length)*0.28);ctx.beginPath();ctx.arc(pt.x,pt.y,Math.max(.5,p.r*(i/p.trail.length)*.55),0,Math.PI*2);ctx.fillStyle=p.color;ctx.globalAlpha=ta;ctx.fill();});
      const mdx=p.x*W-mx,mdy=p.y*H-my,md=Math.sqrt(mdx*mdx+mdy*mdy);
      if(md<130){p.vx+=mdx/md*.0006;p.vy+=mdy/md*.0006;}
      const sp=Math.sqrt(p.vx*p.vx+p.vy*p.vy);if(sp>.0022){p.vx=p.vx/sp*.0022;p.vy=p.vy/sp*.0022;}
      const r=Math.max(.5,p.r+Math.sin(p.pulse)*p.r*.35);
      ctx.beginPath();ctx.arc(p.x*W,p.y*H,r,0,Math.PI*2);ctx.fillStyle=p.color;ctx.globalAlpha=Math.max(0,p.alpha*(.7+.3*Math.sin(p.pulse)));ctx.fill();ctx.globalAlpha=1;
      p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>1)p.vx*=-1;if(p.y<0||p.y>1)p.vy*=-1;p.x=Math.max(0,Math.min(1,p.x));p.y=Math.max(0,Math.min(1,p.y));
    });
    // Shooting stars
    if(frame%75===0&&stars.length<7)spawnStar();
    for(let i=stars.length-1;i>=0;i--){const s=stars[i];s.x+=s.vx;s.y+=s.vy;s.life-=.012;if(s.life<=0||s.x>1.2){stars.splice(i,1);continue;}const sx=s.x*W,sy=s.y*H,ex=sx-s.len*W,ey=sy-s.len*H*.2;const g=ctx.createLinearGradient(ex,ey,sx,sy);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,s.color.replace('1)',s.life*.85+')'));ctx.beginPath();ctx.moveTo(ex,ey);ctx.lineTo(sx,sy);ctx.strokeStyle=g;ctx.lineWidth=1.4+s.life;ctx.globalAlpha=s.life;ctx.stroke();ctx.beginPath();ctx.arc(sx,sy,Math.max(.5,1.8*s.life),0,Math.PI*2);ctx.fillStyle='#fff';ctx.globalAlpha=s.life*.7;ctx.fill();ctx.globalAlpha=1;}
    // Ripples
    for(let i=ripples.length-1;i>=0;i--){const rip=ripples[i];rip.r+=4;rip.alpha*=.93;if(rip.alpha<.01){ripples.splice(i,1);continue;}ctx.beginPath();ctx.arc(rip.x,rip.y,rip.r,0,Math.PI*2);ctx.strokeStyle='rgba(0,255,225,0.8)';ctx.lineWidth=1.5;ctx.globalAlpha=rip.alpha;ctx.stroke();ctx.globalAlpha=1;}
    // Mouse aura
    if(mx>0){try{const mg=ctx.createRadialGradient(mx,my,0,mx,my,90);mg.addColorStop(0,'rgba(0,255,225,0.04)');mg.addColorStop(1,'rgba(0,0,0,0)');ctx.beginPath();ctx.arc(mx,my,90,0,Math.PI*2);ctx.fillStyle=mg;ctx.globalAlpha=1;ctx.fill();}catch(e){}}
    requestAnimationFrame(draw);
  }
  resize();window.addEventListener('resize',resize);draw();
})();

/* ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ */
let agColor='#00ffe1';
const today=()=>new Date().toISOString().split('T')[0];
const fmt=n=>'S/ '+Number(n||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtN=n=>Number(n||0).toLocaleString('es-PE',{minimumFractionDigits:0,maximumFractionDigits:0});
function monthsAgo(d){const dd=new Date(d),now=new Date();return(now.getFullYear()-dd.getFullYear())*12+(now.getMonth()-dd.getMonth());}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
function toast(msg,type=''){
  const wrap=document.getElementById('toast-wrap');
  const el=document.createElement('div');
  el.className=`toast-item t-${type}`;el.innerHTML=msg;
  wrap.appendChild(el);setTimeout(()=>el.classList.add('show'),10);
  setTimeout(()=>{el.classList.remove('show');setTimeout(()=>el.remove(),400);},3000);
}

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
function getUsers(){try{return JSON.parse(localStorage.getItem('fc_biz_users')||'[]');}catch(e){return[];}}
function saveUsers(u){localStorage.setItem('fc_biz_users',JSON.stringify(u));}
function getUser(){try{const s=localStorage.getItem('fc_biz_session');return s?JSON.parse(s):null;}catch(e){return null;}}
function setUser(u){localStorage.setItem('fc_biz_session',JSON.stringify(u));}
function clearSession(){localStorage.removeItem('fc_biz_session');}

/* ‚îÄ‚îÄ‚îÄ STORAGE (con Google Sheets como BD) ‚îÄ‚îÄ‚îÄ */
function sk(k){const u=getUser();return'fc_biz_'+(u?u.username:'g')+'_'+k;}
function ld(k,fb){try{const r=localStorage.getItem(sk(k));return r?JSON.parse(r):fb;}catch(e){return fb;}}
function sd(k,v){try{localStorage.setItem(sk(k),JSON.stringify(v));}catch(e){}}

let agentes=[],ventas=[],pagos=[],bonos=[],gastos=[],decomisiones=[],descuentos=[];
function loadAll(){agentes=ld('ag',[]);ventas=ld('vs',[]);pagos=ld('pg',[]);bonos=ld('bn',[]);gastos=ld('gs',[]);decomisiones=ld('dc',[]);descuentos=ld('des',[]);}
function saveAll(){
  sd('ag',agentes);sd('vs',ventas);sd('pg',pagos);sd('bn',bonos);sd('gs',gastos);sd('dc',decomisiones);sd('des',descuentos);
  if(GS.enabled) scheduleSyncToSheets();
}

/* ‚îÄ‚îÄ‚îÄ GOOGLE SHEETS INTEGRATION ‚îÄ‚îÄ‚îÄ */
const GS = {
  get url(){ return localStorage.getItem('fc_gs_url')||''; },
  get enabled(){ return !!this.url; },
  async _req(params){
    try{
      const controller = new AbortController();
      const timer = setTimeout(()=>controller.abort(), 20000);
      // Usar POST para evitar el l√≠mite de tama√±o de URL en GET (~8KB)
      const r = await fetch(this.url, {
        redirect: 'follow',
        signal: controller.signal,
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: Object.entries(params).map(([k,v])=>
          encodeURIComponent(k)+'='+encodeURIComponent(typeof v==='object'?JSON.stringify(v):String(v))
        ).join('&')
      });
      clearTimeout(timer);
      return JSON.parse(await r.text());
    }catch(e){
      if(e.name==='AbortError') console.warn('GS timeout');
      else console.warn('GS error:',e.message);
      return null;
    }
  },
  async ping(){ return await this._req({action:'ping'}); },
  async push(data){ return await this._req({action:'push',data:JSON.stringify(data)}); },
  async pull(){ const r=await this._req({action:'pull'}); return r&&r.ok?r.data:null; }
};

let syncTimer=null;
function scheduleSyncToSheets(){
  clearTimeout(syncTimer);
  syncTimer=setTimeout(syncToSheets,2000);
}
async function syncToSheets(){
  if(!GS.enabled) return;
  setGSStatus('syncing');
  const data={agentes,ventas,pagos,bonos,gastos,decomisiones,descuentos};
  const r=await GS.push(data);
  if(r&&r.ok){setGSStatus('ok');toast('‚òÅÔ∏è Datos guardados en Sheets','ok');}
  else{setGSStatus('error');console.warn('GS push failed');}
}
// Sync silencioso en segundo plano ‚Äî nunca bloquea la UI
async function syncBackground(){
  if(!GS.enabled) return;
  setGSStatus('syncing');
  try {
    const timeoutPromise = new Promise(resolve=>setTimeout(()=>resolve(null),10000));
    const remote = await Promise.race([GS.pull(), timeoutPromise]);
    if(remote && remote.agentes && remote.agentes.length){
      agentes=remote.agentes;
      ventas=remote.ventas||ventas;
      pagos=remote.pagos||pagos;
      bonos=remote.bonos||bonos;
      gastos=remote.gastos||gastos;
      decomisiones=remote.decomisiones||decomisiones;
      descuentos=remote.descuentos||descuentos;
      sd('ag',agentes);sd('vs',ventas);sd('pg',pagos);
      sd('bn',bonos);sd('gs',gastos);sd('dc',decomisiones);sd('des',descuentos);
      setGSStatus('ok');
      renderDashboard();
      toast('‚òÅÔ∏è Sincronizado ‚Äî '+agentes.length+' agentes ¬∑ '+ventas.length+' ventas','ok');
    } else if(!remote || (!remote.agentes?.length && !remote.ventas?.length)){
      // Sheets vac√≠o o sin respuesta ‚Äî NO auto-push para evitar duplicar
      // El usuario debe usar "Subir a Sheets" manualmente si quiere subir
      setGSStatus(remote ? 'ok' : 'error');
      if(!remote) toast('üì¥ Sin conexi√≥n a Sheets ‚Äî datos locales','warn');
    } else {
      setGSStatus(remote ? 'ok' : 'error');
      if(!remote) toast('üì¥ Sin conexi√≥n a Sheets ‚Äî datos locales','warn');
    }
  } catch(e){
    setGSStatus('error');
  }
}

async function syncNow(){
  showSyncOverlay('Sincronizando con Sheets...');
  await syncBackground();
  hideSyncOverlay();
  renderDashboard();
}

async function forcePushToSheets(){
  if(!GS.enabled){toast('‚ö†Ô∏è Conecta Google Sheets primero');return;}
  if(!confirm('¬øSobreescribir Sheets con los datos de este dispositivo?'))return;
  setGSStatus('syncing');
  await syncToSheets();
  toast('‚úÖ Datos subidos a Sheets','ok');
}

async function forcePullFromSheets(){
  if(!GS.enabled){toast('‚ö†Ô∏è Conecta Google Sheets primero');return;}
  if(!confirm('¬øReemplazar datos de este dispositivo con los de Sheets?'))return;
  showSyncOverlay('Descargando desde Sheets...');
  await syncNow();
  hideSyncOverlay();
  renderDashboard();
}

function setGSStatus(state){
  const dot=document.getElementById('gs-dot');
  const txt=document.getElementById('gs-status-txt');
  const syncBtn=document.getElementById('btn-sync-now');
  const states={off:{txt:'Sin conectar',dotClass:''},syncing:{txt:'Sincronizando...',dotClass:'syncing'},ok:{txt:'Sheets conectado ‚úì',dotClass:'on'},error:{txt:'Error de conexi√≥n',dotClass:''}};
  const s=states[state]||states.off;
  if(txt) txt.textContent=s.txt;
  if(dot) dot.className='gs-dot'+(s.dotClass?' '+s.dotClass:'');
  if(syncBtn) syncBtn.style.display=GS.enabled?'flex':'none';
}
function updateGSUI(){
  const url=GS.url;
  const row=document.getElementById('gs-connected-row');
  const shortEl=document.getElementById('gs-url-short');
  const manualActions=document.getElementById('gs-manual-actions');
  if(url){
    if(row) row.style.display='flex';
    if(shortEl) shortEl.textContent=url.slice(0,60)+'...';
    if(manualActions) manualActions.style.display='block';
    document.getElementById('gs-url-input').value=url;
    setGSStatus('ok');
  } else {
    if(row) row.style.display='none';
    if(manualActions) manualActions.style.display='none';
    setGSStatus('off');
  }
}
async function connectSheets(){
  const url=document.getElementById('gs-url-input').value.trim();
  const errEl=document.getElementById('gs-err');
  const okEl=document.getElementById('gs-ok');
  errEl.style.display='none'; okEl.style.display='none';

  // Validar URL
  if(!url){errEl.textContent='‚ö† Pega la URL del Apps Script primero.';errEl.style.display='block';return;}
  if(!url.startsWith('https://script.google.com/macros')){
    errEl.textContent='‚ö† URL inv√°lida. Debe empezar con https://script.google.com/macros/s/...';
    errEl.style.display='block';return;
  }
  if(!url.endsWith('/exec')){
    errEl.textContent='‚ö† La URL debe terminar en /exec. Verific√° que copiaste la URL completa de "Implementar como app web".';
    errEl.style.display='block';return;
  }

  localStorage.setItem('fc_gs_url',url);
  setGSStatus('syncing');
  errEl.style.display='none';
  toast('üîó Probando conexi√≥n...');

  // PASO 1: Ping
  const pingRes = await GS.ping();
  if(!pingRes){
    localStorage.removeItem('fc_gs_url');
    errEl.innerHTML='‚ùå <strong>Sin respuesta del servidor.</strong><br>Causas m√°s comunes:<br>‚Ä¢ La implementaci√≥n tiene acceso "Solo yo" ‚Üí cambiarlo a <strong>"Cualquier persona"</strong><br>‚Ä¢ No re-implementaste despu√©s de cambiar el c√≥digo ‚Üí <strong>Implementar ‚Üí Nueva versi√≥n</strong><br>‚Ä¢ La URL es de una versi√≥n anterior, no la √∫ltima';
    errEl.style.display='block'; setGSStatus('off'); return;
  }
  if(!pingRes.ok){
    localStorage.removeItem('fc_gs_url');
    errEl.innerHTML='‚ùå <strong>El script respondi√≥ con error:</strong> '+(pingRes.error||JSON.stringify(pingRes))+'<br>Revis√° que el c√≥digo est√© bien pegado en Apps Script.';
    errEl.style.display='block'; setGSStatus('off'); return;
  }

  // Ping OK ‚Üí conectar
  okEl.innerHTML='‚úÖ Conexi√≥n exitosa. Subiendo datos...';
  okEl.style.display='block';
  updateGSUI();

  // PASO 2: Push
  const data={agentes,ventas,pagos,bonos,gastos,decomisiones,descuentos};
  const pushRes = await GS.push(data);
  if(!pushRes||!pushRes.ok){
    errEl.innerHTML='‚ö† Conexi√≥n OK pero <strong>fall√≥ al guardar datos</strong>.<br>'+(pushRes?.error||'Sin detalles del error')+'<br>Verific√° que el SHEET_ID en el script sea correcto y que el Sheet exista.';
    errEl.style.display='block';
    okEl.style.display='none';
    setGSStatus('error');
    return;
  }

  // Todo OK
  okEl.innerHTML='‚úÖ Conectado y datos guardados en Sheets correctamente.';
  setGSStatus('ok');
  toast('‚úÖ Google Sheets conectado ‚Äî '+pushRes.pushed?.join(', '),'ok');
  setTimeout(()=>closeM('modal-gs'),2000);
}
function disconnectSheets(){
  if(!confirm('¬øDesconectar Google Sheets? Los datos quedar√°n solo en este dispositivo.'))return;
  localStorage.removeItem('fc_gs_url');
  updateGSUI();toast('üîå Google Sheets desconectado');
  closeM('modal-gs');
}

const GS_SCRIPT = `// FiberTel Center ‚Äî Google Apps Script v5
// IMPORTANTE: usa doPost (no doGet) para enviar datos sin l√≠mite de tama√±o
// 1. Borra todo el c√≥digo anterior en Apps Script
// 2. Pega este c√≥digo
// 3. Reemplaza TU_SPREADSHEET_ID con tu ID real
// 4. Implementar ‚Üí Nueva implementaci√≥n ‚Üí Tipo: App web
//    Ejecutar como: Yo  |  Acceso: Cualquier persona  ‚Üí Implementar
// 5. Pega la nueva URL en la app

var SHEET_ID = 'TU_SPREADSHEET_ID';
var TABLES   = ['agentes','ventas','pagos','bonos','gastos','decomisiones','descuentos'];

function doPost(e) {
  try {
    var params = e.parameter;
    var action = params.action;
    if (action === 'ping') return res({ok:true, pong:true, version:5});
    if (action === 'push') return pushData(JSON.parse(params.data));
    if (action === 'pull') return pullData();
    return res({ok:false, error:'Unknown action: ' + action});
  } catch(err) {
    return res({ok:false, error:err.message});
  }
}

function doGet(e) {
  try {
    var action = e.parameter.action;
    if (action === 'ping') return res({ok:true, pong:true, version:5});
    if (action === 'pull') return pullData();
    return res({ok:false, error:'Use POST for push'});
  } catch(err) {
    return res({ok:false, error:err.message});
  }
}

function pushData(data) {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  for (var t = 0; t < TABLES.length; t++) {
    var name = TABLES[t];
    var rows = data[name];
    if (!rows || !Array.isArray(rows) || rows.length === 0) continue;
    var sheet = ss.getSheetByName(name);
    if (!sheet) sheet = ss.insertSheet(name);
    sheet.clearContents();
    var headers = Object.keys(rows[0]);
    sheet.appendRow(headers);
    for (var i = 0; i < rows.length; i++) {
      var row = rows[i];
      var rowArr = [];
      for (var j = 0; j < headers.length; j++) {
        var v = row[headers[j]];
        if (v === null || v === undefined) { rowArr.push(''); continue; }
        if (typeof v === 'object') { rowArr.push(JSON.stringify(v)); continue; }
        rowArr.push(String(v));
      }
      sheet.appendRow(rowArr);
    }
  }
  var log = ss.getSheetByName('_sync_log');
  if (!log) log = ss.insertSheet('_sync_log');
  log.appendRow([new Date().toISOString(), 'PUSH', 'OK']);
  return res({ok:true, pushed:true, timestamp:new Date().toISOString()});
}

function pullData() {
  var ss = SpreadsheetApp.openById(SHEET_ID);
  var result = {};
  for (var t = 0; t < TABLES.length; t++) {
    var name = TABLES[t];
    var sheet = ss.getSheetByName(name);
    if (!sheet) { result[name] = []; continue; }
    var values = sheet.getDataRange().getValues();
    if (values.length < 2) { result[name] = []; continue; }
    var headers = [];
    for (var h = 0; h < values[0].length; h++) headers.push(String(values[0][h]));
    var arr = [];
    for (var i = 1; i < values.length; i++) {
      var row = values[i];
      var empty = true;
      for (var j = 0; j < row.length; j++) { if (row[j] !== '') { empty = false; break; } }
      if (empty) continue;
      var obj = {};
      for (var k = 0; k < headers.length; k++) {
        var v = row[k];
        if (v instanceof Date) {
          v = Utilities.formatDate(v, Session.getScriptTimeZone(), 'yyyy-MM-dd');
        } else if (typeof v === 'string' && (v.charAt(0) === '{' || v.charAt(0) === '[')) {
          try { v = JSON.parse(v); } catch(e2) {}
        }
        obj[headers[k]] = v;
      }
      arr.push(obj);
    }
    result[name] = arr;
  }
  var log = ss.getSheetByName('_sync_log');
  if (!log) log = ss.insertSheet('_sync_log');
  log.appendRow([new Date().toISOString(), 'PULL', 'OK']);
  return res({ok:true, data:result});
}

function res(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}`;

function showGSScript(){
  document.getElementById('gs-code-content').textContent=GS_SCRIPT;
  openM('modal-gs-script');
}
function copyGSCode(){
  navigator.clipboard.writeText(GS_SCRIPT).then(()=>toast('üìã C√≥digo copiado al portapapeles','ok'));
}

/* ‚îÄ‚îÄ‚îÄ COMPUTED ‚îÄ‚îÄ‚îÄ */
// Todas las funciones base respetan globalMes si est√° activo
const totalCom=()=>getIngMes(globalMes);
const totalDec=()=>getDecosMes(globalMes).reduce((s,d)=>s+d.monto,0);
const totalPagos=()=>getPagosMes(globalMes).reduce((s,p)=>s+p.monto,0)+getBonosMes(globalMes).reduce((s,b)=>s+b.monto,0);
const totalGastos=()=>getGastosMes(globalMes).reduce((s,g)=>s+g.monto,0);
const totalEg=()=>totalPagos()+totalGastos();
const balNeto=()=>totalCom()-totalEg();
// Totales SIEMPRE acumulados (para gr√°ficos hist√≥ricos y balance total)
const totalComAll=()=>ventas.reduce((s,v)=>s+v.comision,0);
const totalEgAll=()=>pagos.reduce((s,p)=>s+p.monto,0)+bonos.reduce((s,b)=>s+b.monto,0)+gastos.reduce((s,g)=>s+g.monto,0);
const totalDecAll=()=>decomisiones.reduce((s,d)=>s+d.monto,0);
const riesgoAct=()=>ventas.filter(v=>!decomisiones.find(d=>d.ventaId===v.id)&&monthsAgo(v.fecha)<6).reduce((s,v)=>s+v.comision,0);
const ventasSafe=()=>ventas.filter(v=>monthsAgo(v.fecha)>=6).length;
const getAg=id=>agentes.find(a=>a.id===id)||{nombre:'Desconocido',color:'#555'};

// Helpers para filtro por mes
function getMesKey(fecha){const d=new Date(fecha||today());return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');}
function getMesLabel(key){const [y,m]=key.split('-');const MESES=['','Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];return MESES[parseInt(m)]+' '+y;}
// getMesPeriodo: devuelve YYYY-MM del per√≠odo al que PERTENECE el registro
// mesRef ya es una clave YYYY-MM (guardada directamente), fecha es una fecha ISO
function getMesPeriodo(x){
  if(x.mesRef && /^\d{4}-\d{2}$/.test(x.mesRef)) return x.mesRef;
  return getMesKey(x.fecha||today());
}
function buildMesFiltro(arr,selId,val){
  const keys=[...new Set(arr.map(x=>getMesPeriodo(x)))].sort().reverse();
  const sel=document.getElementById(selId);if(!sel)return;
  sel.innerHTML='<option value="">Todos los meses</option>'+keys.map(k=>`<option value="${k}" ${val===k?'selected':''}>${getMesLabel(k)}</option>`).join('');
}

/* ‚îÄ‚îÄ‚îÄ GLOBAL MES FILTER ‚îÄ‚îÄ‚îÄ */
let globalMes='',vSearch='',vCamp='',vMes='',nomMes='';
function setGlobalMes(val){
  globalMes=val;
  vMes=''; nomMes='';
  // Reset filtros locales para que no confundan con el filtro global
  const resEl=document.getElementById('global-mes-resumen');
  if(val&&resEl){
    const ing=getIngMes(val),eg=getEgMes(val);
    resEl.textContent=`Ingresos: S/${ing.toFixed(0)} ¬∑ Egresos: S/${eg.toFixed(0)} ¬∑ Balance: S/${(ing-eg).toFixed(0)}`;
  } else if(resEl){ resEl.textContent=''; }
  const activePage=document.querySelector('.page.active');
  if(activePage){
    const id=activePage.id.replace('page-','');
    ({dashboard:renderDashboard,ventas:renderVentas,nomina:renderNomina,decomisiones:renderDecomisiones,agentes:renderAgentes,gastos:renderGastos,balance:renderBalance,educacion:renderEducacion,analisis:renderAnalisis})[id]?.();
  }
}
function buildGlobalMesFiltro(){
  // Usar getMesPeriodo para que bonos y descuentos aparezcan en su mes correcto
  const all=[
    ...ventas.map(x=>({periodo:getMesKey(x.fecha)})),
    ...pagos.map(x=>({periodo:getMesKey(x.fecha)})),
    ...bonos.map(x=>({periodo:getMesPeriodo(x)})),
    ...gastos.map(x=>({periodo:getMesKey(x.fecha)})),
    ...decomisiones.map(x=>({periodo:getMesKey(x.fecha)})),
    ...descuentos.map(x=>({periodo:getMesPeriodo(x)})),
  ];
  const keys=[...new Set(all.map(x=>x.periodo))].sort().reverse();
  const sel=document.getElementById('global-mes');if(!sel)return;
  const cur=sel.value;
  sel.innerHTML='<option value="">üìä Todos los meses (acumulado)</option>'+keys.map(k=>`<option value="${k}" ${cur===k?'selected':''}>${getMesLabel(k)}</option>`).join('');
}
function getVentasMes(mes){return mes?ventas.filter(v=>getMesKey(v.fecha)===mes):ventas;}
function getPagosMes(mes){return mes?pagos.filter(p=>getMesKey(p.fecha)===mes):pagos;}
function getBonosMes(mes){return mes?bonos.filter(b=>getMesPeriodo(b)===mes):bonos;}
function getGastosMes(mes){return mes?gastos.filter(g=>getMesKey(g.fecha)===mes):gastos;}
function getDecosMes(mes){return mes?decomisiones.filter(d=>getMesKey(d.fecha)===mes):decomisiones;}
function getDescsMes(mes){return mes?descuentos.filter(d=>getMesPeriodo(d)===mes):descuentos;}
function getIngMes(mes){return getVentasMes(mes).reduce((s,v)=>s+v.comision,0);}
function getEgMes(mes){return getPagosMes(mes).reduce((s,p)=>s+p.monto,0)+getBonosMes(mes).reduce((s,b)=>s+b.monto,0)+getGastosMes(mes).reduce((s,g)=>s+g.monto,0);}

/* ‚îÄ‚îÄ‚îÄ AN√ÅLISIS ‚îÄ‚îÄ‚îÄ */
function renderAnalisis(){
  buildGlobalMesFiltro();
  const now=new Date();
  const curMes=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
  const prevDate=new Date(now.getFullYear(),now.getMonth()-1,1);
  const prevMes=prevDate.getFullYear()+'-'+String(prevDate.getMonth()+1).padStart(2,'0');
  const ingCur=getIngMes(curMes),egCur=getEgMes(curMes),balCur=ingCur-egCur;
  const vCur=getVentasMes(curMes),dcCur=getDecosMes(curMes);
  const ingPrev=getIngMes(prevMes),egPrev=getEgMes(prevMes),balPrev=ingPrev-egPrev;
  const vPrev=getVentasMes(prevMes),dcPrev=getDecosMes(prevMes);
  const pct=(a,b)=>b===0?null:((a-b)/b*100);
  const arrow=(p)=>p===null?'‚Äî':p>=0?`‚ñ≤ +${p.toFixed(1)}%`:`‚ñº ${p.toFixed(1)}%`;
  const arrowColor=(p)=>p===null?'var(--txt3)':p>=0?'var(--neon)':'var(--hot)';
  const metricas=[
    {label:'Ingresos',cur:ingCur,prev:ingPrev,fmt:true,mejor:'mayor'},
    {label:'Egresos',cur:egCur,prev:egPrev,fmt:true,mejor:'menor'},
    {label:'Balance',cur:balCur,prev:balPrev,fmt:true,mejor:'mayor'},
    {label:'Ventas',cur:vCur.length,prev:vPrev.length,mejor:'mayor'},
    {label:'Decomisiones',cur:dcCur.length,prev:dcPrev.length,mejor:'menor'},
  ];
  document.getElementById('analisis-comparativa').innerHTML=`
    <div style="overflow-x:auto;">
    <table style="width:100%;border-collapse:collapse;">
      <thead><tr>
        <th style="text-align:left;padding:8px;color:var(--txt3);font-size:9px;letter-spacing:2px;">M√âTRICA</th>
        <th style="padding:8px;color:var(--txt3);font-size:9px;letter-spacing:2px;">${getMesLabel(prevMes)}</th>
        <th style="padding:8px;color:var(--neon);font-size:9px;letter-spacing:2px;">${getMesLabel(curMes)}</th>
        <th style="padding:8px;color:var(--txt3);font-size:9px;letter-spacing:2px;">VARIACI√ìN</th>
        <th style="padding:8px;color:var(--txt3);font-size:9px;letter-spacing:2px;">ESTADO</th>
      </tr></thead>
      <tbody>${metricas.map(m=>{const p=pct(m.cur,m.prev);const bueno=(m.mejor==='mayor'&&(p===null||p>=0))||(m.mejor==='menor'&&(p===null||p<=0));const estado=m.cur===0&&m.prev===0?'Sin datos':bueno?'‚úÖ Mejora':'‚ö†Ô∏è Atenci√≥n';return`<tr style="border-bottom:1px solid var(--b1);">
          <td style="padding:10px 8px;font-weight:600;font-size:12px;">${m.label}</td>
          <td style="padding:10px 8px;text-align:center;font-family:'DM Mono',monospace;color:var(--txt2);">${m.fmt?fmt(m.prev):m.prev}</td>
          <td style="padding:10px 8px;text-align:center;font-family:'DM Mono',monospace;font-weight:700;color:var(--neon);">${m.fmt?fmt(m.cur):m.cur}</td>
          <td style="padding:10px 8px;text-align:center;font-family:'DM Mono',monospace;font-size:11px;color:${arrowColor(p)};">${arrow(p)}</td>
          <td style="padding:10px 8px;text-align:center;font-size:11px;text-transform:none;">${estado}</td>
        </tr>`;}).join('')}</tbody>
    </table></div>
    ${ingCur===0&&ingPrev===0?'<div class="empty" style="margin-top:10px;">üìã Registra ventas para ver la comparativa</div>':''}`;
  const margen=ingCur>0?(balCur/ingCur*100):0;
  const tasa_deco=vCur.length>0?(dcCur.length/vCur.length*100):0;
  const com_prom=vCur.length>0?(ingCur/vCur.length):0;
  document.getElementById('analisis-kpis').innerHTML=[
    {ico:'üí∞',lbl:'Ingresos del mes',val:fmt(ingCur),sub:'comisiones cobradas',c:'var(--neon)'},
    {ico:'üìâ',lbl:'Egresos del mes',val:fmt(egCur),sub:'n√≥mina + gastos',c:'var(--hot)'},
    {ico:'üìä',lbl:'Margen neto',val:margen.toFixed(1)+'%',sub:margen>=20?'‚úÖ Saludable':margen>=0?'‚ö†Ô∏è Por mejorar':'üî¥ Negativo',c:margen>=20?'var(--neon)':margen>=0?'var(--amber)':'var(--hot)'},
    {ico:'üèÜ',lbl:'Ventas del mes',val:vCur.length,sub:'contratos cerrados',c:'var(--blue)'},
    {ico:'‚ö†Ô∏è',lbl:'Tasa decomisi√≥n',val:tasa_deco.toFixed(1)+'%',sub:tasa_deco<=10?'‚úÖ Controlada':tasa_deco<=20?'‚ö†Ô∏è Revisar':'üî¥ Alta',c:tasa_deco<=10?'var(--neon)':tasa_deco<=20?'var(--amber)':'var(--hot)'},
    {ico:'üéØ',lbl:'Comisi√≥n promedio',val:fmt(com_prom),sub:'por venta este mes',c:'var(--purple)'},
  ].map(k=>`<div class="mc" style="cursor:default;"><div class="mc-lbl">${k.lbl}</div><div class="mc-val" style="color:${k.c};font-size:22px;">${k.val}</div><div class="mc-sub" style="text-transform:none;">${k.sub}</div><div class="mc-ico">${k.ico}</div></div>`).join('');
  const checks=[
    {label:'Margen neto ‚â• 20%',ok:margen>=20,val:`${margen.toFixed(1)}%`,rec:margen<0?'Egresos superan ingresos. Reducir costos es urgente.':margen<20?'Aumenta ventas o reduce gastos para llegar al 20%.':'Excelente margen.'},
    {label:'Ventas ‚â• mes anterior',ok:vCur.length>=vPrev.length,val:`${vCur.length} vs ${vPrev.length}`,rec:vCur.length<vPrev.length?`Ca√≠ste ${vPrev.length-vCur.length} ventas. Revisar seguimiento a leads.`:'Crecimiento sostenido.'},
    {label:'Tasa decomisi√≥n ‚â§ 10%',ok:tasa_deco<=10,val:`${tasa_deco.toFixed(1)}%`,rec:tasa_deco>10?'Revisar calidad de leads y proceso de instalaci√≥n.':'Cartera bien mantenida.'},
    {label:'Balance positivo',ok:balCur>=0,val:fmt(balCur),rec:balCur<0?'Gast√°s m√°s de lo que ingres√°s. Revisar n√≥mina y gastos.':'El negocio est√° generando excedente.'},
    {label:'Egresos ‚â§ 70% de ingresos',ok:ingCur===0||(egCur/ingCur)<=0.70,val:ingCur>0?`${(egCur/ingCur*100).toFixed(1)}%`:'‚Äî',rec:ingCur>0&&egCur/ingCur>0.70?'Estructura de costos pesada. Revisar gastos fijos.':'Estructura de costos saludable.'},
  ];
  document.getElementById('analisis-salud').innerHTML=checks.map(c=>`
    <div style="display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--b1);">
      <div style="font-size:18px;flex-shrink:0;margin-top:2px;">${c.ok?'‚úÖ':'‚ö†Ô∏è'}</div>
      <div style="flex:1;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:3px;">
          <span style="font-weight:600;font-size:12px;">${c.label}</span>
          <span style="font-family:'DM Mono',monospace;font-size:11px;color:${c.ok?'var(--neon)':'var(--amber)'};">${c.val}</span>
        </div>
        <div style="font-size:11px;color:var(--txt2);text-transform:none;letter-spacing:normal;">${c.rec}</div>
      </div>
    </div>`).join('');
  const recs=[];
  if(balCur<0) recs.push({p:1,ico:'üö®',titulo:'URGENTE: Balance negativo este mes',desc:`Gast√°s S/${fmt(Math.abs(balCur))} m√°s de lo que ingres√°s. (1) Congelar gastos no esenciales. (2) Escalonar pagos de n√≥mina. (3) Acelerar cobro de comisiones pendientes.`,color:'var(--hot)'});
  if(tasa_deco>20) recs.push({p:1,ico:'üö®',titulo:`URGENTE: Tasa de decomisi√≥n muy alta (${tasa_deco.toFixed(1)}%)`,desc:'M√°s de 1 de cada 5 ventas se cancela. Implementar checklist de calificaci√≥n antes de cerrar contrato y mejorar seguimiento post-instalaci√≥n.',color:'var(--hot)'});
  if(vCur.length<vPrev.length&&vPrev.length>0) recs.push({p:2,ico:'‚ö†Ô∏è',titulo:`Ca√≠da de ${vPrev.length-vCur.length} ventas vs mes anterior`,desc:`${vPrev.length} ventas el mes pasado vs ${vCur.length} este mes. Revisar pipeline de leads, motivaci√≥n del equipo y si hubo cambios en campa√±as activas.`,color:'var(--amber)'});
  if(margen>=0&&margen<20&&ingCur>0) recs.push({p:2,ico:'‚ö†Ô∏è',titulo:`Margen del ${margen.toFixed(1)}% ‚Äî objetivo ‚â• 20%`,desc:`Necesit√°s ganar S/${fmt(ingCur*0.20-balCur)} m√°s (o gastar esa cifra menos) para llegar al margen saludable. Apuntar a productos de mayor comisi√≥n o reducir gastos operativos.`,color:'var(--amber)'});
  if(ingCur>0&&egCur/ingCur>0.70) recs.push({p:2,ico:'üìä',titulo:`Egresos al ${(egCur/ingCur*100).toFixed(0)}% de ingresos`,desc:`Por cada S/100 que ingresa, S/${(egCur/ingCur*100).toFixed(0)} se va en costos. Revisar si la n√≥mina est√° alineada con la producci√≥n y si hay gastos recurrentes que se puedan negociar.`,color:'var(--amber)'});
  if(vCur.length>=vPrev.length&&margen>=20&&balCur>0) recs.push({p:3,ico:'üöÄ',titulo:'Mes s√≥lido ‚Äî momento de escalar',desc:`${vCur.length} ventas y margen del ${margen.toFixed(1)}%. Ahora: (1) Establecer meta m√°s alta para el pr√≥ximo mes. (2) Evaluar incorporar un agente m√°s. (3) Alimentar fondo de reserva anti-decomisiones (recomendado: ${fmt(ingCur*0.20)}).`,color:'var(--neon)'});
  const agRanking=agentes.map(ag=>{const aVentas=getVentasMes(curMes).filter(v=>v.agenteId===ag.id);return{ag,ventas:aVentas.length};}).sort((a,b)=>b.ventas-a.ventas);
  if(agRanking.length>1){const top=agRanking[0],bot=agRanking[agRanking.length-1];if(top.ventas>0&&bot.ventas<top.ventas*0.5) recs.push({p:3,ico:'üë•',titulo:`Brecha de rendimiento: ${top.ag.nombre} lidera con ${top.ventas} vs ${bot.ventas} de ${bot.ag.nombre}`,desc:`Considera que ${top.ag.nombre} comparta sus t√©cnicas con el equipo. Una reuni√≥n semanal de casos exitosos puede elevar el rendimiento promedio.`,color:'var(--blue)'});}
  if(recs.length===0) recs.push({p:3,ico:'üìã',titulo:'Registra m√°s datos para obtener recomendaciones',desc:'A medida que cargues ventas, gastos y pagos, este panel generar√° un plan de acci√≥n espec√≠fico para tu negocio.',color:'var(--txt3)'});
  recs.sort((a,b)=>a.p-b.p);
  document.getElementById('analisis-recs').innerHTML=recs.map(r=>`
    <div style="display:flex;gap:14px;padding:16px;border-radius:12px;background:var(--s2);border:1px solid ${r.color}33;margin-bottom:10px;">
      <div style="font-size:24px;flex-shrink:0;">${r.ico}</div>
      <div><div style="font-weight:700;font-size:12.5px;color:${r.color};margin-bottom:5px;text-transform:none;letter-spacing:normal;">${r.titulo}</div>
      <div style="font-size:11.5px;color:var(--txt2);line-height:1.6;text-transform:none;letter-spacing:normal;">${r.desc}</div></div>
    </div>`).join('');
}
function riskLevel(m){
  if(m>=6) return{label:'Consolidada ‚úì',cls:'pill-g',color:'var(--neon)'};
  if(m>=4) return{label:(6-m)+' mes(es) riesgo',cls:'pill-a',color:'var(--amber)'};
  return{label:'‚ö† '+(6-m)+' mes(es)',cls:'pill-r',color:'var(--hot)'};
}

/* ‚îÄ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ‚îÄ */
const charts={};
function dc(k){if(charts[k]){charts[k].destroy();delete charts[k];}}
function monthLabels(n){const M=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];const now=new Date();return Array.from({length:n},(_,i)=>{const d=new Date(now.getFullYear(),now.getMonth()-(n-1-i),1);return M[d.getMonth()];});}
function mTotals(arr,field,n){const now=new Date();return Array.from({length:n},(_,i)=>{const d=new Date(now.getFullYear(),now.getMonth()-(n-1-i),1);const yr=d.getFullYear(),mo=d.getMonth();return arr.filter(x=>{const xd=new Date(x.fecha||today());return xd.getFullYear()===yr&&xd.getMonth()===mo;}).reduce((s,x)=>s+(x[field]||0),0);});}
const chartOpts=(ycb)=>({plugins:{legend:{labels:{color:'#8898c0',font:{size:10,family:'DM Sans'}}}},scales:{x:{ticks:{color:'#3d4f78',font:{family:'DM Mono',size:9}},grid:{color:'rgba(255,255,255,.022)'},border:{color:'transparent'}},y:{ticks:{color:'#3d4f78',font:{family:'DM Mono',size:9},callback:ycb||((v)=>'S/'+fmtN(v))},grid:{color:'rgba(255,255,255,.022)'},border:{color:'transparent'}}}});

/* ‚îÄ‚îÄ‚îÄ MOBILE SIDEBAR ‚îÄ‚îÄ‚îÄ */
function showSyncOverlay(txt){
  const el=document.getElementById('sync-overlay');
  const txtEl=document.getElementById('sync-overlay-txt');
  if(txtEl) txtEl.textContent=txt||'Sincronizando...';
  if(el) el.style.display='flex';
}
function hideSyncOverlay(){
  const el=document.getElementById('sync-overlay');
  if(el) el.style.display='none';
}
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  const ov=document.getElementById('sidebar-overlay');
  const btn=document.getElementById('mob-toggle');
  const isOpen=sb.classList.contains('open');
  if(isOpen){closeSidebar();}else{
    sb.classList.add('open');
    ov.classList.add('open');
    btn.classList.add('open');
  }
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('open');
  document.getElementById('mob-toggle').classList.remove('open');
}

/* ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ */
function showPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(el) el.classList.add('active');
  else document.querySelectorAll('.ni').forEach(n=>{if(n.getAttribute('onclick')&&n.getAttribute('onclick').includes("'"+id+"'"))n.classList.add('active');});
  ({dashboard:renderDashboard,ventas:renderVentas,nomina:renderNomina,decomisiones:renderDecomisiones,agentes:renderAgentes,gastos:renderGastos,balance:renderBalance,educacion:renderEducacion,analisis:renderAnalisis})[id]?.();
  // Cerrar sidebar en m√≥vil al navegar
  if(window.innerWidth<=768) closeSidebar();
}

/* ‚îÄ‚îÄ‚îÄ SALARY CALCULATOR ‚îÄ‚îÄ‚îÄ */
function calcSalarySuggested(){
  const ing=totalCom(),eg=totalEg(),bal=balNeto();
  const sueldo=Math.max(0,bal*0.30);
  const reserva=Math.max(0,bal*0.20);
  const reinversion=Math.max(0,bal*0.50);
  return{ing,eg,bal,sueldo,reserva,reinversion};
}
function updateSalaryWidgets(){
  const {ing,eg,bal,sueldo,reserva,reinversion}=calcSalarySuggested();
  document.getElementById('d-salary-main').textContent=fmt(sueldo);
  document.getElementById('sb-30').textContent=fmt(sueldo);
  document.getElementById('sb-20').textContent=fmt(reserva);
  document.getElementById('sb-50').textContent=fmt(reinversion);
  let detail=bal>0?`Balance: ${fmt(bal)} | Regla 30-20-50 aplicada`:`Egresos superan ingresos ‚Äî sueldo: S/ 0`;
  document.getElementById('d-salary-detail').textContent=detail;
}

/* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ */
function renderDashboard(){
  buildGlobalMesFiltro();
  const vF=getVentasMes(globalMes), pgF=getPagosMes(globalMes), bnF=getBonosMes(globalMes), gsF=getGastosMes(globalMes), dcF=getDecosMes(globalMes);
  const com=vF.reduce((s,v)=>s+v.comision,0);
  const eg=pgF.reduce((s,p)=>s+p.monto,0)+bnF.reduce((s,b)=>s+b.monto,0)+gsF.reduce((s,g)=>s+g.monto,0);
  const bal=com-eg, risk=riesgoAct(), margen=com>0?(bal/com*100):0;
  document.getElementById('d-com').textContent=fmt(com);
  document.getElementById('d-eg').textContent=fmt(eg);
  document.getElementById('d-bal').textContent=fmt(bal);
  document.getElementById('d-bal').style.color=bal>=0?'var(--neon)':'var(--hot)';
  document.getElementById('d-risk').textContent=fmt(risk);
  document.getElementById('d-vs').textContent=vF.length;
  document.getElementById('d-ag').textContent=agentes.length;
  document.getElementById('d-margen').textContent=margen.toFixed(1)+'%';
  document.getElementById('d-margen').style.color=margen>=20?'var(--neon)':margen>=0?'var(--amber)':'var(--hot)';
  document.getElementById('risk-total').textContent=fmt(risk);
  document.getElementById('risk-count').textContent=ventas.filter(v=>!decomisiones.find(d=>d.ventaId===v.id)&&monthsAgo(v.fecha)<6).length+' ventas < 6 meses';
  document.getElementById('v-badge').textContent=ventas.length;
  document.getElementById('dc-badge').textContent=decomisiones.length;
  document.getElementById('dash-fecha').textContent=globalMes?'Per√≠odo: '+getMesLabel(globalMes):new Date().toLocaleDateString('es-PE',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  updateSalaryWidgets();

  dc('flow');
  const labels=monthLabels(6);
  const ingD=mTotals(ventas,'comision',6);
  const egD=Array.from({length:6},(_,i)=>{const now=new Date();const d=new Date(now.getFullYear(),now.getMonth()-(5-i),1);const yr=d.getFullYear(),mo=d.getMonth();const f=(arr)=>arr.filter(x=>{const xd=new Date(x.fecha||today());return xd.getFullYear()===yr&&xd.getMonth()===mo;}).reduce((s,x)=>s+(x.monto||0),0);return f(pagos)+f(bonos)+f(gastos);});
  charts['flow']=new Chart(document.getElementById('flowChart').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'Comisiones',data:ingD,backgroundColor:'rgba(0,255,225,.55)',borderRadius:6,borderSkipped:false},{label:'Egresos',data:egD,backgroundColor:'rgba(255,45,110,.45)',borderRadius:6,borderSkipped:false}]},options:chartOpts()});
  dc('eg');
  const tNom=pgF.reduce((s,p)=>s+p.monto,0)+bnF.reduce((s,b)=>s+b.monto,0),tGas=gsF.reduce((s,g)=>s+g.monto,0),tDec=totalDec();
  if(tNom+tGas+tDec>0){charts['eg']=new Chart(document.getElementById('egresoChart').getContext('2d'),{type:'doughnut',data:{labels:['N√≥mina & Bonos','Gastos Operativos','Decomisiones'],datasets:[{data:[tNom,tGas,tDec],backgroundColor:['rgba(77,166,255,.7)','rgba(255,176,32,.7)','rgba(255,45,110,.7)'],borderWidth:0,hoverOffset:5}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#8898c0',font:{size:10,family:'DM Sans'},padding:7,boxWidth:8}}},cutout:'65%'}});}

  const recent=[...ventas].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).slice(0,8);
  if(!recent.length){document.getElementById('dash-table').innerHTML='<tr><td colspan="7"><div class="empty">üìã Sin ventas ‚Äî agrega tu primera venta</div></td></tr>';return;}
  document.getElementById('dash-table').innerHTML=recent.map(v=>{const ag=getAg(v.agenteId);const m=monthsAgo(v.fecha);const rl=riskLevel(m);
    return`<tr><td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${v.fecha}</td>
    <td><div class="ar"><div class="av" style="background:${ag.color};">${ag.nombre.slice(0,2).toUpperCase()}</div>${ag.nombre}</div></td>
    <td><span class="pill pill-b">${v.campana}</span></td><td><span class="pill pill-v">${v.producto}</span></td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--neon);">${fmt(v.comision)}</td>
    <td style="font-family:'DM Mono',monospace;font-size:10px;">${m} mes(es)</td>
    <td><span class="pill ${rl.cls}">${rl.label}</span></td></tr>`;}).join('');
}

/* ‚îÄ‚îÄ‚îÄ VENTAS ‚îÄ‚îÄ‚îÄ */
function renderVentas(){
  buildSel('v-agente');
  buildMesFiltro(ventas,'v-mes-filter',vMes);
  let list=[...ventas];
  if(vSearch) list=list.filter(v=>v.cliente?.toLowerCase().includes(vSearch)||getAg(v.agenteId).nombre.toLowerCase().includes(vSearch)||v.campana.toLowerCase().includes(vSearch));
  if(vCamp) list=list.filter(v=>v.campana===vCamp);
  if(vMes) list=list.filter(v=>getMesKey(v.fecha)===vMes);
  list.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  const camps=[...new Set(ventas.map(v=>v.campana))];
  const cf=document.getElementById('v-camp-filter');
  if(cf){cf.innerHTML='<option value="">Todas las campa√±as</option>'+camps.map(c=>`<option value="${c}" ${vCamp===c?'selected':''}>${c}</option>`).join('');}
  document.getElementById('v-count').textContent=list.length+' venta(s)'+(vMes?' ‚Äî '+getMesLabel(vMes):'');
  if(!list.length){document.getElementById('v-table').innerHTML='<tr><td colspan="9"><div class="empty">üìã Sin ventas'+(vMes?' en '+getMesLabel(vMes):' registradas')+'</div></td></tr>';return;}
  document.getElementById('v-table').innerHTML=list.map(v=>{const ag=getAg(v.agenteId);const m=monthsAgo(v.fecha);const rl=riskLevel(m);const dec=decomisiones.find(d=>d.ventaId===v.id);
    return`<tr><td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${v.fecha}</td>
    <td><div class="ar"><div class="av" style="background:${ag.color};width:24px;height:24px;font-size:10px;">${ag.nombre.slice(0,2).toUpperCase()}</div>${ag.nombre}</div></td>
    <td><span class="pill pill-b">${v.campana}</span></td><td><span class="pill pill-v">${v.producto}</span></td>
    <td style="color:var(--txt2);font-size:11px;">${v.cliente||'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--neon);">${fmt(v.comision)}</td>
    <td style="font-family:'DM Mono',monospace;font-size:10px;">${m} mes(es)</td>
    <td>${dec?'<span class="pill pill-r">Decomisionada</span>':`<span class="pill ${rl.cls}">${rl.label}</span>`}</td>
    <td style="display:flex;gap:4px;"><button class="db" onclick="openEditVenta(${v.id})" title="Editar">‚úèÔ∏è</button><button class="db" onclick="delVenta(${v.id})">üóë</button></td></tr>`;}).join('');
}
function filterVentas(v){vSearch=v.toLowerCase();renderVentas();}
function filterVentasCamp(v){vCamp=v;renderVentas();}
function filterVentasMes(v){vMes=v;renderVentas();}
function delVenta(id){if(!confirm('¬øEliminar esta venta?'))return;ventas=ventas.filter(v=>v.id!==id);saveAll();renderVentas();renderDashboard();toast('üóëÔ∏è Venta eliminada');}
function openEditVenta(id){
  const v=ventas.find(x=>x.id===id);if(!v)return;
  buildSel('ev-agente');
  document.getElementById('ev-id').value=id;
  document.getElementById('ev-agente').value=v.agenteId;
  document.getElementById('ev-fecha').value=v.fecha;
  document.getElementById('ev-campana').value=v.campana;
  document.getElementById('ev-producto').value=v.producto;
  document.getElementById('ev-cliente').value=v.cliente||'';
  document.getElementById('ev-comision').value=v.comision;
  openM('modal-edit-venta');
}
function saveEditVenta(){
  const id=parseInt(document.getElementById('ev-id').value);
  const idx=ventas.findIndex(x=>x.id===id);if(idx<0)return;
  const ag=document.getElementById('ev-agente').value;
  const com=parseFloat(document.getElementById('ev-comision').value);
  if(!ag||!com){toast('‚ö†Ô∏è Completa todos los campos');return;}
  ventas[idx]={...ventas[idx],
    agenteId:parseInt(ag),
    fecha:document.getElementById('ev-fecha').value,
    campana:document.getElementById('ev-campana').value,
    producto:document.getElementById('ev-producto').value,
    cliente:document.getElementById('ev-cliente').value,
    comision:com
  };
  saveAll();closeModals();renderVentas();renderDashboard();
  toast('‚úÖ Venta actualizada','ok');
}

/* ‚îÄ‚îÄ‚îÄ N√ìMINA ‚îÄ‚îÄ‚îÄ */
let nomChart=null;
function filterNominaMes(v){nomMes=v;renderNomina();}
function renderNomina(){
  buildSel('p-agente');buildSel('b-agente');buildSel('desc-agente');
  const pgF=nomMes?pagos.filter(p=>getMesKey(p.fecha)===nomMes):pagos;
  const bnF=nomMes?bonos.filter(b=>getMesPeriodo(b)===nomMes):bonos;
  const dsF=nomMes?descuentos.filter(d=>getMesPeriodo(d)===nomMes):descuentos;
  buildMesFiltro([...pagos,...bonos,...descuentos],'nom-mes-filter',nomMes);
  const agD=agentes.map(ag=>{
    const apg=pgF.filter(p=>p.agenteId===ag.id);
    const abn=bnF.filter(b=>b.agenteId===ag.id);
    const ades=dsF.filter(d=>d.agenteId===ag.id);
    const base=apg.filter(p=>p.tipo==='Sueldo base').reduce((s,p)=>s+p.monto,0);
    const cInt=apg.filter(p=>p.tipo==='Comisi√≥n internet').reduce((s,p)=>s+p.monto,0);
    const cMov=apg.filter(p=>p.tipo==='Comisi√≥n m√≥vil').reduce((s,p)=>s+p.monto,0);
    const bnsEsp=apg.filter(p=>p.tipo==='Bono especial').reduce((s,p)=>s+p.monto,0);
    const bns=abn.reduce((s,b)=>s+b.monto,0)+bnsEsp;
    const adl=apg.filter(p=>p.tipo==='Adelanto').reduce((s,p)=>s+p.monto,0);
    const des=ades.reduce((s,d)=>s+d.monto,0);
    return{ag,base,cInt,cMov,bns,adl,des,total:base+cInt+cMov+bns-des};
  });
  const tBase=agD.reduce((s,d)=>s+d.base,0),tCom=agD.reduce((s,d)=>s+d.cInt+d.cMov,0),tBon=agD.reduce((s,d)=>s+d.bns,0),tDes=agD.reduce((s,d)=>s+d.des,0),grand=tBase+tCom+tBon-tDes;
  document.getElementById('nom-total').textContent=fmt(grand)+(nomMes?' ('+getMesLabel(nomMes)+')':'');
  document.getElementById('nom-breakdown').innerHTML=[
    {l:'Sueldos base',v:tBase,c:'var(--blue)'},{l:'Comisiones',v:tCom,c:'var(--neon)'},
    {l:'Bonos',v:tBon,c:'var(--amber)'},{l:'Descuentos',v:-tDes,c:'var(--hot)'}
  ].map(r=>`<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--b1);font-size:11.5px;text-transform:none;letter-spacing:normal;"><span style="color:var(--txt2);">${r.l}</span><span style="font-family:'DM Mono',monospace;font-weight:700;color:${r.c};">${r.v<0?'‚àí '+fmt(Math.abs(r.v)):fmt(r.v)}</span></div>`).join('');
  if(nomChart) nomChart.destroy();
  if(tBase+tCom+tBon>0){nomChart=new Chart(document.getElementById('nominaChart').getContext('2d'),{type:'doughnut',data:{labels:['Sueldos','Comisiones','Bonos','Descuentos'],datasets:[{data:[tBase,tCom,tBon,tDes],backgroundColor:['rgba(77,166,255,.7)','rgba(0,255,225,.7)','rgba(255,176,32,.7)','rgba(255,45,110,.7)'],borderWidth:0}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#8898c0',font:{size:10},padding:6,boxWidth:8}}},cutout:'62%'}});}
  if(!agentes.length){document.getElementById('nom-table').innerHTML='<tr><td colspan="8"><div class="empty">üë• Sin agentes</div></td></tr>';return;}
  document.getElementById('nom-table').innerHTML=agD.map(d=>`<tr>
    <td><div class="ar"><div class="av" style="background:${d.ag.color};width:26px;height:26px;font-size:10px;">${d.ag.nombre.slice(0,2).toUpperCase()}</div><span style="font-weight:600;">${d.ag.nombre}</span></div></td>
    <td style="font-family:'DM Mono',monospace;">${fmt(d.base)}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--neon);">${fmt(d.cInt)}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--cyan);">${fmt(d.cMov)}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--amber);">${fmt(d.bns)}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--txt2);">${fmt(d.adl)}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--hot);font-weight:700;">${d.des>0?'‚àí '+fmt(d.des):'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:${d.total>=0?'var(--neon)':'var(--hot)'};">${fmt(d.total)}</td></tr>`).join('');
  const totalDesc=dsF.reduce((s,d)=>s+d.monto,0);
  document.getElementById('desc-total-lbl').textContent='Total: '+fmt(totalDesc);
  const TIPO_ICONS={'Falta injustificada':'‚ùå','Tardanza':'‚è∞','Decomisi√≥n descontada':'üìâ','Pr√©stamo / Adelanto':'üíµ','Error operativo':'‚ö†Ô∏è','Otro':'üìã'};
  document.getElementById('desc-table').innerHTML=dsF.length?[...dsF].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(d=>{const ag=getAg(d.agenteId);return`<tr>
    <td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${d.fecha}</td>
    <td><div class="ar"><div class="av" style="background:${ag.color};width:24px;height:24px;font-size:9px;">${ag.nombre.slice(0,2).toUpperCase()}</div>${ag.nombre}</div></td>
    <td><span class="pill pill-r">${TIPO_ICONS[d.tipo]||'üìã'} ${d.tipo}</span></td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--hot);">‚àí ${fmt(d.monto)}</td>
    <td style="color:var(--txt2);font-size:11px;text-transform:none;">${d.detalle||'‚Äî'}${d.cantidad>1?' (√ó'+d.cantidad+')':''}</td>
    <td><button class="db" onclick="delDescuento(${d.id})">üóë</button></td></tr>`;}).join(''):'<tr><td colspan="6"><div class="empty">‚úÖ Sin descuentos'+(nomMes?' en '+getMesLabel(nomMes):' registrados')+'</div></td></tr>';
  const allPag=[...pgF,...bnF.map(b=>({...b,tipo:'Bono'}))].sort((a,b)=>new Date(b.fecha||today())-new Date(a.fecha||today()));
  document.getElementById('pagos-table').innerHTML=allPag.length?allPag.map(p=>{const ag=getAg(p.agenteId);return`<tr>
    <td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${p.fecha||'‚Äî'}</td>
    <td><div class="ar"><div class="av" style="background:${ag.color};width:22px;height:22px;font-size:9px;">${ag.nombre.slice(0,2).toUpperCase()}</div>${ag.nombre}</div></td>
    <td><span class="pill ${p.tipo==='Sueldo base'?'pill-b':p.tipo==='Bono'||p.tipo==='Bono especial'?'pill-a':'pill-g'}">${p.tipo}</span></td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--hot);">${fmt(p.monto)}</td>
    <td style="color:var(--txt2);font-size:11px;text-transform:none;">${p.nota||p.motivo||'‚Äî'}</td>
    <td><button class="db" onclick="delPago(${p.id})">üóë</button></td></tr>`;}).join(''):'<tr><td colspan="6"><div class="empty">Sin pagos'+(nomMes?' en '+getMesLabel(nomMes):' registrados')+'</div></td></tr>';
}
function delPago(id){pagos=pagos.filter(p=>p.id!==id);bonos=bonos.filter(b=>b.id!==id);saveAll();renderNomina();toast('üóëÔ∏è Pago eliminado');}
function delDescuento(id){if(!confirm('¬øEliminar este descuento?'))return;descuentos=descuentos.filter(d=>d.id!==id);saveAll();renderNomina();toast('üóëÔ∏è Descuento eliminado');}

/* ‚îÄ‚îÄ‚îÄ DESCUENTO MODAL HELPERS ‚îÄ‚îÄ‚îÄ */
function updateDescPlaceholder(){
  const tipo=document.getElementById('desc-tipo').value;
  const lbl=document.getElementById('desc-cant-lbl');
  const cantInput=document.getElementById('desc-cant');
  if(tipo==='Tardanza'){lbl.textContent='(minutos tarde)';cantInput.placeholder='30';}
  else if(tipo==='Falta injustificada'){lbl.textContent='(cantidad de faltas)';cantInput.placeholder='1';}
  else{lbl.textContent='(cantidad)';cantInput.placeholder='1';}
  calcDescuento();
}
function calcDescuento(){
  const diario=parseFloat(document.getElementById('calc-diario').value)||0;
  const cant=parseFloat(document.getElementById('calc-cant').value)||0;
  const tipo=document.getElementById('desc-tipo').value;
  const res=document.getElementById('calc-result');
  if(!diario||!cant){res.style.display='none';return;}
  let monto=0,detalle='';
  if(tipo==='Tardanza'){
    // tardanza: proporci√≥n por hora (sueldo diario / 8 horas / 60 min)
    const porMin=diario/8/60;
    monto=porMin*cant;
    detalle=`${cant} min √ó S/${(porMin).toFixed(2)}/min = S/${monto.toFixed(2)}`;
  } else {
    monto=diario*cant;
    detalle=`${cant} d√≠a(s) √ó S/${diario.toFixed(2)} = S/${monto.toFixed(2)}`;
  }
  res.style.display='block';
  res.innerHTML=`üí° Descuento calculado: <strong style="color:var(--hot);">S/ ${monto.toFixed(2)}</strong><br><span style="font-size:10px;opacity:.7;">${detalle}</span>`;
  // Auto-rellenar el campo monto
  document.getElementById('desc-monto').value=monto.toFixed(2);
}
function openModalDesc(){
  buildSel('desc-agente');
  document.getElementById('desc-fecha').value=today();
  document.getElementById('desc-monto').value='';
  document.getElementById('desc-cant').value='1';
  document.getElementById('desc-detalle').value='';
  document.getElementById('calc-diario').value='';
  document.getElementById('calc-cant').value='';
  document.getElementById('calc-result').style.display='none';
  // Poblar selector de mes de referencia
  const now=new Date();
  const sel=document.getElementById('desc-mes-ref');
  sel.innerHTML='';
  for(let i=0;i<6;i++){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const opt=document.createElement('option');
    opt.value=key;opt.textContent=getMesLabel(key);
    if(i===0)opt.selected=true;
    sel.appendChild(opt);
  }
  updateDescPlaceholder();
  openM('modal-descuento');
}
function saveDescuento(){
  const ag=document.getElementById('desc-agente').value;
  const m=parseFloat(document.getElementById('desc-monto').value);
  const tipo=document.getElementById('desc-tipo').value;
  if(!ag||!m){toast('‚ö†Ô∏è Selecciona agente y monto');return;}
  const fecha=document.getElementById('desc-fecha').value;
  const mesRef=document.getElementById('desc-mes-ref').value||getMesKey(fecha);
  descuentos.push({
    id:Date.now(),
    agenteId:parseInt(ag),
    fecha,
    mesRef,
    tipo,
    monto:m,
    cantidad:parseInt(document.getElementById('desc-cant').value)||1,
    detalle:document.getElementById('desc-detalle').value
  });
  saveAll();closeModals();renderNomina();
  toast('üìâ Descuento registrado ‚Äî '+fmt(m)+' ('+getMesLabel(mesRef)+')','warn');
}

/* ‚îÄ‚îÄ‚îÄ DECOMISIONES ‚îÄ‚îÄ‚îÄ */
function renderDecomisiones(){
  document.getElementById('dc-riesgo').textContent=fmt(riesgoAct());
  document.getElementById('dc-total').textContent=fmt(totalDec());
  document.getElementById('dc-safe').textContent=ventasSafe();
  document.getElementById('dc-count').textContent=decomisiones.length+' registradas';
  dc('risk');
  const labels=monthLabels(6);
  const rD=Array.from({length:6},(_,i)=>{const now=new Date();const d=new Date(now.getFullYear(),now.getMonth()-(5-i),1);const yr=d.getFullYear(),mo=d.getMonth();return ventas.filter(v=>{const vd=new Date(v.fecha);return vd.getFullYear()===yr&&vd.getMonth()===mo&&monthsAgo(v.fecha)<6&&!decomisiones.find(dd=>dd.ventaId===v.id);}).reduce((s,v)=>s+v.comision,0);});
  charts['risk']=new Chart(document.getElementById('riskChart').getContext('2d'),{type:'bar',data:{labels,datasets:[{label:'En riesgo (S/)',data:rD,backgroundColor:'rgba(255,176,32,.55)',borderRadius:5,borderSkipped:false}]},options:chartOpts()});
  const totRisk=riesgoAct();
  document.getElementById('risk-by-agent').innerHTML=agentes.map(ag=>({ag,risk:ventas.filter(v=>v.agenteId===ag.id&&monthsAgo(v.fecha)<6&&!decomisiones.find(d=>d.ventaId===v.id)).reduce((s,v)=>s+v.comision,0)})).sort((a,b)=>b.risk-a.risk).map(({ag,risk})=>`
    <div style="display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--b1);">
      <div class="av" style="background:${ag.color};width:26px;height:26px;font-size:10px;">${ag.nombre.slice(0,2).toUpperCase()}</div>
      <div style="flex:1;"><div style="font-size:11.5px;font-weight:600;">${ag.nombre}</div>
      <div style="height:3px;background:var(--s3);border-radius:99px;margin-top:4px;overflow:hidden;"><div style="width:${totRisk>0?(risk/totRisk*100):0}%;height:100%;background:${ag.color};border-radius:99px;"></div></div></div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--amber);">${fmt(risk)}</div>
    </div>`).join('')||'<div class="empty">Sin riesgo activo üõ°Ô∏è</div>';
  document.getElementById('dc-table').innerHTML=decomisiones.length?[...decomisiones].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(d=>{const v=ventas.find(vv=>vv.id===d.ventaId)||{};const ag=getAg(v.agenteId);return`<tr>
    <td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${d.fecha}</td>
    <td><div class="ar"><div class="av" style="background:${ag.color};width:24px;height:24px;font-size:9px;">${ag.nombre.slice(0,2).toUpperCase()}</div>${ag.nombre}</div></td>
    <td style="color:var(--txt2);font-size:11px;">${v.cliente||'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;font-size:10.5px;">${monthsAgo(v.fecha||d.fecha)} mes(es)</td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--hot);">${fmt(d.monto)}</td>
    <td><span class="pill pill-r">${d.motivo}</span></td>
    <td><button class="db" onclick="delDC(${d.id})">üóë</button></td></tr>`}).join(''):'<tr><td colspan="7"><div class="empty">Sin decomisiones registradas ‚úÖ</div></td></tr>';
}
function delDC(id){decomisiones=decomisiones.filter(d=>d.id!==id);saveAll();renderDecomisiones();toast('üóëÔ∏è Decomisi√≥n eliminada');}

/* ‚îÄ‚îÄ‚îÄ AGENTES ‚îÄ‚îÄ‚îÄ */
function renderAgentes(){
  buildSel('v-agente');
  buildGlobalMesFiltro();
  if(!agentes.length){document.getElementById('agent-cards').innerHTML='';document.getElementById('ag-table').innerHTML='<tr><td colspan="9"><div class="empty">üë• Sin agentes ‚Äî agrega tu primer agente</div></td></tr>';return;}
  const ROL_ICO={'Comercial':'üíº','BackOffice':'üñ•Ô∏è','Supervisor':'üëë'};
  const ROL_COLOR={'Comercial':'var(--neon)','BackOffice':'var(--blue)','Supervisor':'var(--amber)'};
  // Gastos compartidos (back+supervisor+gastos operativos) repartidos entre comerciales
  const comerciales=agentes.filter(a=>(a.rol||'Comercial')==='Comercial');
  const totalGastosOp=totalGastos(); // ya respeta globalMes
  const totalSueldosSoporte=agentes.filter(a=>a.rol==='BackOffice'||a.rol==='Supervisor')
    .reduce((s,a)=>{
      const apg=getPagosMes(globalMes).filter(p=>p.agenteId===a.id);
      return s+apg.reduce((ss,p)=>ss+p.monto,0);
    },0);
  const totalCostoCompartido=totalGastosOp+totalSueldosSoporte;
  const costoPorComercial=comerciales.length>0?(totalCostoCompartido/comerciales.length):0;
  const agStats=agentes.map(ag=>{
    const rol=ag.rol||'Comercial';
    const avs=getVentasMes(globalMes).filter(v=>v.agenteId===ag.id);
    const avsAll=ventas.filter(v=>v.agenteId===ag.id);
    const com=avs.reduce((s,v)=>s+v.comision,0);
    const comAll=avsAll.reduce((s,v)=>s+v.comision,0);
    const risk=avsAll.filter(v=>monthsAgo(v.fecha)<6&&!decomisiones.find(d=>d.ventaId===v.id)).reduce((s,v)=>s+v.comision,0);
    const decs=decomisiones.filter(d=>{const v=ventas.find(vv=>vv.id===d.ventaId);return v&&v.agenteId===ag.id;}).length;
    const pct=ag.meta&&avs.length?Math.min((avs.length/ag.meta)*100,100):0;
    // Costo directo: sus pagos del per√≠odo
    const costoDirecto=getPagosMes(globalMes).filter(p=>p.agenteId===ag.id).reduce((s,p)=>s+p.monto,0)
      +getBonosMes(globalMes).filter(b=>b.agenteId===ag.id).reduce((s,b)=>s+b.monto,0);
    // Costo total para comerciales: directo + cuota parte de gastos compartidos
    const costoTotal=rol==='Comercial'?costoDirecto+costoPorComercial:costoDirecto;
    const rentabilidad=rol==='Comercial'&&costoTotal>0?((com-costoTotal)/costoTotal*100):null;
    return{ag,rol,ventas:avs.length,com,comAll,risk,decs,pct,costoDirecto,costoTotal,rentabilidad};
  }).sort((a,b)=>{
    const order={'Comercial':0,'Supervisor':1,'BackOffice':2};
    return (order[a.rol]||0)-(order[b.rol]||0)||b.com-a.com;
  });
  const periodoLbl=globalMes?' ('+getMesLabel(globalMes)+')':'';
  document.getElementById('agent-cards').innerHTML=agStats.map(s=>{
    const rentColor=s.rentabilidad===null?'var(--txt3)':s.rentabilidad>=50?'var(--neon)':s.rentabilidad>=0?'var(--amber)':'var(--hot)';
    return`<div class="ap-card">
      <div class="ap-top">
        <div class="ap-av" style="background:${s.ag.color};">${s.ag.nombre.slice(0,2).toUpperCase()}</div>
        <span class="pill" style="background:${ROL_COLOR[s.rol]}22;color:${ROL_COLOR[s.rol]};border:1px solid ${ROL_COLOR[s.rol]}44;">${ROL_ICO[s.rol]} ${s.rol}</span>
      </div>
      <div class="ap-name">${s.ag.nombre}</div>
      <div style="font-size:10px;color:var(--txt2);text-transform:none;letter-spacing:normal;">Meta: ${s.ag.meta||'‚Äî'}/mes ¬∑ Desde ${s.ag.inicio||'‚Äî'}</div>
      ${s.rol==='Comercial'?`
        <div style="font-family:'DM Mono',monospace;font-size:18px;font-weight:700;color:var(--neon);margin-top:7px;">${fmt(s.com)} <span style="font-size:10px;color:var(--txt3);">ingresos${periodoLbl}</span></div>
        <div style="display:flex;justify-content:space-between;margin-top:4px;">
          <div style="font-size:10px;color:var(--hot);text-transform:none;">Costo total: ${fmt(s.costoTotal)}</div>
          <div style="font-size:10px;font-weight:700;color:${rentColor};">${s.rentabilidad!==null?(s.rentabilidad>=0?'‚ñ≤':'‚ñº')+Math.abs(s.rentabilidad).toFixed(0)+'% rent.':'‚Äî'}</div>
        </div>
        <div style="font-size:10px;color:var(--amber);text-transform:none;">En riesgo: ${fmt(s.risk)}</div>
        <div class="pbar"><div class="pfill" style="width:${s.pct}%;background:${s.ag.color};"></div></div>
        <div style="font-size:9px;color:var(--txt3);">${s.pct.toFixed(0)}% de meta mensual ¬∑ ${s.ventas} ventas</div>
      `:`
        <div style="font-size:11px;color:var(--txt2);margin-top:7px;text-transform:none;">Costo del per√≠odo: ${fmt(s.costoDirecto)}</div>
        <div style="font-size:10px;color:var(--txt3);text-transform:none;">Gasto operativo del negocio</div>
      `}
    </div>`;}).join('');
  document.getElementById('ag-table').innerHTML=`
    <thead><tr><th>#</th><th>Agente</th><th>Rol</th><th>Ventas</th><th>Comisiones</th><th>En riesgo</th><th>Decomis.</th><th>Meta</th><th></th></tr></thead>
    <tbody>${agStats.map((s,i)=>`<tr>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:${i===0&&s.rol==='Comercial'?'var(--amber)':i===1&&s.rol==='Comercial'?'var(--txt2)':'var(--txt3)'};">${i===0&&s.rol==='Comercial'?'ü•á':i===1&&s.rol==='Comercial'?'ü•à':i===2&&s.rol==='Comercial'?'ü•â':'‚Äî'}</td>
    <td><div class="ar"><div class="av" style="background:${s.ag.color};">${s.ag.nombre.slice(0,2).toUpperCase()}</div><div><div style="font-weight:600;">${s.ag.nombre}</div><div style="font-size:9.5px;color:var(--txt3);text-transform:none;">Desde ${s.ag.inicio||'‚Äî'}</div></div></div></td>
    <td><span class="pill" style="background:${ROL_COLOR[s.rol]}22;color:${ROL_COLOR[s.rol]};border:1px solid ${ROL_COLOR[s.rol]}44;">${ROL_ICO[s.rol]} ${s.rol}</span></td>
    <td style="font-family:'DM Mono',monospace;">${s.rol==='Comercial'?s.ventas:'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--neon);font-weight:700;">${s.rol==='Comercial'?fmt(s.com):'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--amber);">${s.rol==='Comercial'?fmt(s.risk):'‚Äî'}</td>
    <td style="font-family:'DM Mono',monospace;color:var(--hot);">${s.rol==='Comercial'?s.decs:'‚Äî'}</td>
    <td>${s.rol==='Comercial'?`<div class="pbar" style="width:90px;"><div class="pfill" style="width:${s.pct}%;background:${s.ag.color};"></div></div><div style="font-size:9px;color:var(--txt3);">${s.pct.toFixed(0)}%</div>`:fmt(s.ag.sueldo||0)+' base'}</td>
    <td style="display:flex;gap:4px;"><button class="db" onclick="openEditAgente(${s.ag.id})" title="Editar">‚úèÔ∏è</button><button class="db" onclick="delAgente(${s.ag.id})">üóë</button></td></tr>`).join('')}</tbody>`;
}
function delAgente(id){if(!confirm('¬øEliminar este agente?'))return;agentes=agentes.filter(a=>a.id!==id);saveAll();renderAgentes();toast('üóëÔ∏è Agente eliminado');}

function openEditAgente(id){
  const ag=agentes.find(a=>a.id===id);if(!ag)return;
  document.getElementById('eag-id').value=id;
  document.getElementById('eag-nombre').value=ag.nombre||'';
  document.getElementById('eag-inicio').value=ag.inicio||'';
  document.getElementById('eag-rol').value=ag.rol||'Comercial';
  document.getElementById('eag-meta').value=ag.meta||'';
  document.getElementById('eag-sueldo').value=ag.sueldo||'';
  document.getElementById('eag-com-int').value=ag.comInt||'';
  document.getElementById('eag-com-mov').value=ag.comMov||'';
  updateEditRolInfo();
  openM('modal-edit-agente');
}
function updateEditRolInfo(){
  const rol=document.getElementById('eag-rol')?.value||'Comercial';
  const info=document.getElementById('eag-rol-info');
  if(!info)return;
  const msgs={
    'Comercial':'üíº <strong>Comercial:</strong> aparece en el selector de ventas. Sus comisiones son ingreso del negocio.',
    'BackOffice':'üñ•Ô∏è <strong>BackOffice:</strong> no genera ventas. Su sueldo se contabiliza como gasto operativo.',
    'Supervisor':'üëë <strong>Supervisor:</strong> gestiona el equipo. Su sueldo se contabiliza como gasto operativo.'
  };
  info.innerHTML=msgs[rol]||msgs['Comercial'];
}
function saveEditAgente(){
  const id=parseInt(document.getElementById('eag-id').value);
  const idx=agentes.findIndex(a=>a.id===id);if(idx<0)return;
  const nombre=document.getElementById('eag-nombre').value.trim();
  if(!nombre){toast('‚ö†Ô∏è Escribe el nombre');return;}
  agentes[idx]={
    ...agentes[idx],
    nombre,
    rol:document.getElementById('eag-rol').value||'Comercial',
    inicio:document.getElementById('eag-inicio').value,
    sueldo:parseFloat(document.getElementById('eag-sueldo').value)||0,
    meta:parseInt(document.getElementById('eag-meta').value)||0,
    comInt:parseFloat(document.getElementById('eag-com-int').value)||0,
    comMov:parseFloat(document.getElementById('eag-com-mov').value)||0,
  };
  saveAll();closeModals();renderAgentes();
  toast('‚úÖ Agente actualizado','ok');
}

/* ‚îÄ‚îÄ‚îÄ GASTOS ‚îÄ‚îÄ‚îÄ */
function renderGastos(){
  buildGlobalMesFiltro();
  const gsF=getGastosMes(globalMes);
  const catSums={};gsF.forEach(g=>{catSums[g.cat]=(catSums[g.cat]||0)+g.monto;});
  dc('gastos');
  if(Object.keys(catSums).length){charts['gastos']=new Chart(document.getElementById('gastosChart').getContext('2d'),{type:'doughnut',data:{labels:Object.keys(catSums),datasets:[{data:Object.values(catSums),backgroundColor:['rgba(0,255,225,.7)','rgba(255,176,32,.7)','rgba(176,106,255,.7)','rgba(16,232,154,.7)','rgba(6,224,224,.7)','rgba(255,45,110,.7)'],borderWidth:0,hoverOffset:5}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#8898c0',font:{size:10},padding:6,boxWidth:8}}},cutout:'65%'}});}
  const tot=gsF.reduce((s,g)=>s+g.monto,0);
  const periodoLbl=globalMes?' ‚Äî '+getMesLabel(globalMes):'';
  // Mostrar total con per√≠odo
  const totEl=document.getElementById('gastos-total-lbl');
  if(totEl) totEl.textContent='Total'+periodoLbl+': '+fmt(tot);
  document.getElementById('gastos-summary').innerHTML=Object.entries(catSums).sort((a,b)=>b[1]-a[1]).map(([cat,sum])=>`
    <div style="display:flex;align-items:center;gap:9px;padding:9px 0;border-bottom:1px solid var(--b1);">
      <div style="flex:1;"><div style="font-size:12px;font-weight:600;text-transform:none;">${cat}</div>
      <div style="height:3px;background:var(--s3);border-radius:99px;margin-top:4px;overflow:hidden;"><div style="width:${tot>0?(sum/tot*100):0}%;height:100%;background:var(--amber);border-radius:99px;"></div></div></div>
      <div style="font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:var(--amber);">${fmt(sum)}</div>
    </div>`).join('')||'<div class="empty" style="padding:12px 0;">Sin gastos'+(globalMes?' en '+getMesLabel(globalMes):' registrados')+'</div>';
  document.getElementById('g-table').innerHTML=gsF.length?[...gsF].sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).map(g=>`<tr>
    <td style="color:var(--txt3);font-family:'DM Mono',monospace;font-size:10px;">${g.fecha}</td>
    <td style="font-weight:500;text-transform:none;">${g.desc}</td>
    <td><span class="pill pill-a">${g.cat}</span></td>
    <td style="font-family:'DM Mono',monospace;font-weight:700;color:var(--hot);">${fmt(g.monto)}</td>
    <td><button class="db" onclick="delGasto(${g.id})">üóë</button></td></tr>`).join(''):'<tr><td colspan="5"><div class="empty">Sin gastos'+(globalMes?' en '+getMesLabel(globalMes):' registrados')+'</div></td></tr>';
}
function delGasto(id){gastos=gastos.filter(g=>g.id!==id);saveAll();renderGastos();toast('üóëÔ∏è Gasto eliminado');}

/* ‚îÄ‚îÄ‚îÄ BALANCE ‚îÄ‚îÄ‚îÄ */
function renderBalance(){
  buildGlobalMesFiltro();
  const ing=totalCom(),eg=totalEg(),ben=ing-eg,risk=riesgoAct(),adj=ben-risk*0.5;
  const periodoLbl=globalMes?' ‚Äî '+getMesLabel(globalMes):'';
  document.getElementById('bal-ing').textContent=fmt(ing);document.getElementById('bal-eg').textContent=fmt(eg);
  document.getElementById('bal-ben').textContent=fmt(ben);document.getElementById('bal-ben').style.color=ben>=0?'var(--neon)':'var(--hot)';
  document.getElementById('bal-adj').textContent=fmt(adj);document.getElementById('bal-adj').style.color=adj>=0?'var(--neon)':'var(--hot)';
  dc('balance');
  // Gr√°fico siempre muestra 6 meses hist√≥ricos (no filtrado)
  const labels=monthLabels(6);
  const ingD=mTotals(ventas,'comision',6);
  const egD=Array.from({length:6},(_,i)=>{const now=new Date();const d=new Date(now.getFullYear(),now.getMonth()-(5-i),1);const yr=d.getFullYear(),mo=d.getMonth();const f=(arr)=>arr.filter(x=>{const xd=new Date(x.mesRef?x.mesRef+'-01':x.fecha||today());return xd.getFullYear()===yr&&xd.getMonth()===mo;}).reduce((s,x)=>s+(x.monto||0),0);return f(pagos)+f(bonos)+f(gastos);});
  const balD=ingD.map((v,i)=>v-egD[i]);
  charts['balance']=new Chart(document.getElementById('balanceChart').getContext('2d'),{type:'line',data:{labels,datasets:[{label:'Ingresos',data:ingD,borderColor:'rgba(0,255,225,.8)',backgroundColor:'rgba(0,255,225,.07)',borderWidth:2,fill:true,tension:.35,pointRadius:3},{label:'Egresos',data:egD,borderColor:'rgba(255,45,110,.7)',backgroundColor:'rgba(255,45,110,.05)',borderWidth:2,fill:false,tension:.35,pointRadius:3},{label:'Balance',data:balD,borderColor:'rgba(77,166,255,.9)',borderWidth:2,fill:false,tension:.35,pointRadius:3,borderDash:[6,3]}]},options:chartOpts()});
  const tNom=totalPagos(),tGas=totalGastos(),tDec=totalDec();
  const rows=[
    {label:'(+) Comisiones cobradas'+periodoLbl,v:ing,tipo:'Ingreso',color:'var(--neon)'},
    {label:'(‚àí) N√≥mina (sueldos + comisiones + bonos)',v:-tNom,tipo:'Egreso',color:'var(--hot)'},
    {label:'(‚àí) Gastos operativos',v:-tGas,tipo:'Egreso',color:'var(--hot)'},
    {label:'(‚àí) Decomisiones realizadas',v:-tDec,tipo:'Egreso',color:'var(--hot)'},
    {label:'(=) BENEFICIO NETO'+periodoLbl,v:ben,tipo:'Resultado',color:ben>=0?'var(--neon)':'var(--hot)',bold:true},
    {label:'(‚àí) Riesgo latente (50% probabilidad)',v:-risk*0.5,tipo:'Riesgo',color:'var(--amber)'},
    {label:'(=) BENEFICIO AJUSTADO'+periodoLbl,v:adj,tipo:'Resultado',color:adj>=0?'var(--neon)':'var(--hot)',bold:true}
  ];
  document.getElementById('pl-table').innerHTML='<table style="width:100%;"><thead><tr><th>Concepto</th><th>Importe</th><th>% ingresos</th><th>Tipo</th></tr></thead><tbody>'+rows.map(r=>`<tr style="${r.bold?'border-top:1px solid var(--b2);':''}"><td style="font-weight:${r.bold?700:400};font-size:${r.bold?'12':'11.5'}px;text-transform:none;">${r.label}</td><td style="font-family:'DM Mono',monospace;font-weight:700;color:${r.color};font-size:12px;">${fmt(r.v)}</td><td style="font-family:'DM Mono',monospace;font-size:10px;color:var(--txt2);">${ing>0?((Math.abs(r.v)/ing)*100).toFixed(1)+'%':'‚Äî'}</td><td><span class="pill ${r.tipo==='Ingreso'?'pill-g':r.tipo==='Egreso'?'pill-r':r.tipo==='Riesgo'?'pill-a':'pill-b'}">${r.tipo}</span></td></tr>`).join('')+'</tbody></table>';
}

/* ‚îÄ‚îÄ‚îÄ EDUCACI√ìN FINANCIERA ‚îÄ‚îÄ‚îÄ */
function renderEducacion(){
  buildGlobalMesFiltro();
  const vF=getVentasMes(globalMes);
  const ing=totalCom(),eg=totalEg(),bal=balNeto(),decos=totalDec(),venT=vF.length;
  const margen=ing>0?((bal/ing)*100):0;
  
  // Margen
  const el1=document.getElementById('edu-margen');
  if(el1) el1.innerHTML=ing>0?`Ingresos: ${fmt(ing)} | Egresos: ${fmt(eg)} | Balance: ${fmt(bal)}<br><strong>Margen: ${margen.toFixed(1)}%</strong> ${margen>=20?'‚úÖ Saludable (objetivo ‚â•20%)':margen>=0?'‚ö†Ô∏è Por mejorar (objetivo ‚â•20%)':'üî¥ NEGATIVO ‚Äî revisar urgente'}`:
    'Registra ventas y gastos para calcular tu margen.';
  
  // Reserva anti-decos
  const reservaRec=ing*0.20;
  const el2=document.getElementById('edu-reserva');
  if(el2) el2.innerHTML=ing>0?`Reserva recomendada (20% de comisiones): <strong style="color:var(--neon);">${fmt(reservaRec)}</strong><br>Decomisiones acumuladas: <strong style="color:var(--hot);">${fmt(decos)}</strong><br>Riesgo activo en cartera: <strong style="color:var(--amber);">${fmt(riesgoAct())}</strong>`:
    'Registra ventas para calcular la reserva recomendada.';
  
  // Punto equilibrio
  const pe=eg;
  const el3=document.getElementById('edu-equilibrio');
  if(el3) el3.innerHTML=eg>0?`Punto de equilibrio mensual: <strong style="color:var(--amber);">${fmt(pe)}</strong><br>Ingresos actuales: <strong style="color:var(--neon);">${fmt(ing)}</strong><br>${ing>eg?`‚úÖ Est√°s ${fmt(ing-eg)} por encima del equilibrio`:`‚ö†Ô∏è Te faltan ${fmt(eg-ing)} para cubrir costos`}`:
    'Registra gastos para calcular el punto de equilibrio.';
  
  // CPV
  const cpv=venT>0?(eg/venT):0;
  const comProm=venT>0?(vF.reduce((s,v)=>s+v.comision,0)/venT):0;
  const el4=document.getElementById('edu-cpv');
  if(el4) el4.innerHTML=venT>0?`Costo por venta: <strong style="color:${cpv<comProm?'var(--neon)':'var(--hot)'};">${fmt(cpv)}</strong><br>Comisi√≥n promedio por venta: <strong>${fmt(comProm)}</strong><br>${cpv<comProm?`‚úÖ Margen por venta: ${fmt(comProm-cpv)}`:`‚ö†Ô∏è El CPV supera la comisi√≥n ‚Äî revisar estructura de costos`}`:
    'Registra ventas y gastos para calcular el CPV.';
  
  // Carga calculadora sueldo con datos reales
  updateSalaryWidgets();
}

function loadRealDataToCalc(){
  const ing=totalCom(),eg=totalEg();
  document.getElementById('sal-ing-input').value=ing.toFixed(2);
  document.getElementById('sal-eg-input').value=eg.toFixed(2);
  calcSalary();
  toast('üìä Datos reales cargados','ok');
}

function calcSalary(){
  const ing=parseFloat(document.getElementById('sal-ing-input').value)||0;
  const eg=parseFloat(document.getElementById('sal-eg-input').value)||0;
  const bal=ing-eg;
  const sueldo=Math.max(0,bal*0.30);
  const reserva=Math.max(0,bal*0.20);
  const reinversion=Math.max(0,bal*0.50);
  document.getElementById('sal-result-main').textContent=fmt(sueldo);
  document.getElementById('sal-r30').textContent=fmt(sueldo);
  document.getElementById('sal-r20').textContent=fmt(reserva);
  document.getElementById('sal-r50').textContent=fmt(reinversion);
  document.getElementById('sal-result-pct').textContent=bal>0?`30% del balance neto (${fmt(bal)})`:bal<0?'Balance negativo ‚Äî sin sueldo':'Ingresa los datos del mes';
  const alertEl=document.getElementById('sal-alert');
  if(bal<0){alertEl.style.display='block';alertEl.textContent=`‚ö†Ô∏è Tus egresos (${fmt(eg)}) superan los ingresos (${fmt(ing)}). No te pagues sueldo hasta equilibrar el negocio. Diferencia: ${fmt(Math.abs(bal))}.`;}
  else if(ing>0&&sueldo<5000){alertEl.style.display='block';alertEl.innerHTML=`üí° Consejo: Con un sueldo de ${fmt(sueldo)}, considera aumentar ventas o reducir gastos para mejorar tu ingreso personal.`;}
  else{alertEl.style.display='none';}
}

function calcBonos(){
  const ventas_sim=parseInt(document.getElementById('bono-ventas').value)||0;
  const el=document.getElementById('edu-bono');
  if(!el) return;
  let bono=0,desc='';
  if(ventas_sim>=200){bono=ventas_sim*500;desc='Nivel √âLITE (+200): S/500 por venta';}
  else if(ventas_sim>=150){bono=ventas_sim*350;desc='Nivel PREMIUM (150-199): S/350 por venta';}
  else if(ventas_sim>=100){bono=ventas_sim*200;desc='Nivel EST√ÅNDAR (100-149): S/200 por venta';}
  else if(ventas_sim>=50){bono=ventas_sim*100;desc='Nivel B√ÅSICO (50-99): S/100 por venta';}
  else{desc='Sin bono ‚Äî m√≠nimo 50 ventas para calificar';}
  el.innerHTML=bono>0?`${desc}<br><strong style="color:var(--neon);font-size:16px;">${fmt(bono)}</strong> de bono estimado`:desc;
}

function calcProyeccion(){
  const meta=parseFloat(document.getElementById('proyeccion-meta').value)||0;
  const el=document.getElementById('edu-proyeccion');
  if(!el||!meta) return;
  const promMensual=totalCom()/Math.max(1,6); // promedio √∫ltimos meses
  if(promMensual<=0){el.textContent='Registra ventas para calcular la proyecci√≥n.';return;}
  const mesesNec=Math.ceil(meta/promMensual);
  const actual=totalCom();
  const falta=Math.max(0,meta-actual);
  el.innerHTML=`Promedio mensual: <strong style="color:var(--neon);">${fmt(promMensual)}</strong><br>Acumulado actual: <strong>${fmt(actual)}</strong><br>Falta para la meta: <strong style="color:var(--amber);">${fmt(falta)}</strong><br>A este ritmo: <strong style="color:var(--purple);">${mesesNec} mes(es) adicionales</strong>`;
}

/* ‚îÄ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ‚îÄ */
function openM(id){document.getElementById(id).classList.add('open');}
function closeM(id){document.getElementById(id).classList.remove('open');}
function closeModals(){document.querySelectorAll('.modal-overlay').forEach(m=>{if(!['modal-recover','modal-profile','modal-gs','modal-gs-script'].includes(m.id)) m.classList.remove('open');});}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));});

// buildSel: si es selector de venta solo muestra Comerciales
function buildSel(id){
  const s=document.getElementById(id);if(!s)return;
  const esVenta = id==='v-agente'||id==='ev-agente';
  const lista = esVenta ? agentes.filter(a=>!a.rol||a.rol==='Comercial') : agentes;
  s.innerHTML=lista.length?lista.map(a=>`<option value="${a.id}">${a.nombre}${a.rol&&a.rol!=='Comercial'?' ('+a.rol+')':''}</option>`).join(''):'<option value="">Sin agentes</option>';
}
// Actualiza info de rol en modal agente
function updateRolInfo(){
  const rol=document.getElementById('ag-rol')?.value;
  const info=document.getElementById('ag-rol-info');
  const comWrap=document.getElementById('ag-com-wrap');
  const comRow2=document.getElementById('ag-com-row2');
  if(!info)return;
  const msgs={
    'Comercial':'üíº <strong>Comercial:</strong> aparece en el selector de ventas. Sus comisiones son el ingreso del negocio.',
    'BackOffice':'üñ•Ô∏è <strong>BackOffice:</strong> no genera ventas directas. Su sueldo se contabiliza como gasto operativo en el balance.',
    'Supervisor':'üëë <strong>Supervisor:</strong> gestiona al equipo. Su sueldo se contabiliza como gasto operativo en el balance.'
  };
  info.innerHTML=msgs[rol]||msgs['Comercial'];
  const esComercial=rol==='Comercial';
  if(comWrap) comWrap.style.opacity=esComercial?'1':'0.4';
  if(comRow2) comRow2.style.opacity=esComercial?'1':'0.4';
}
function pickC(c,el){agColor=c;document.querySelectorAll('#ag-colpick div').forEach(d=>d.style.border='2px solid transparent');el.style.border='2px solid #fff';}

function openModalV(){buildSel('v-agente');document.getElementById('v-fecha').value=today();document.getElementById('v-comision').value='';document.getElementById('v-cliente').value='';document.getElementById('v-nota').value='';openM('modal-venta');}
function getCatsGasto(){
  const def=['Infraestructura','Servicios b√°sicos','Tecnolog√≠a','Marketing','Transportes','Otros'];
  try{const saved=JSON.parse(localStorage.getItem('fc_cats_gasto')||'[]');return [...new Set([...def,...saved])].sort();}catch(e){return def;}
}
function addCatGasto(){
  const nueva=prompt('Nombre de la nueva categor√≠a:')?.trim();
  if(!nueva)return;
  try{
    const saved=JSON.parse(localStorage.getItem('fc_cats_gasto')||'[]');
    if(!saved.includes(nueva)){saved.push(nueva);localStorage.setItem('fc_cats_gasto',JSON.stringify(saved));}
  }catch(e){}
  buildCatSelect('g-cat',nueva);
  toast('‚úÖ Categor√≠a "'+nueva+'" creada','ok');
}
function buildCatSelect(selId,selected){
  const sel=document.getElementById(selId);if(!sel)return;
  const cats=getCatsGasto();
  sel.innerHTML=cats.map(c=>`<option value="${c}" ${selected===c?'selected':''}>${c}</option>`).join('');
}
function openModalG(){
  document.getElementById('g-fecha').value=today();
  document.getElementById('g-monto').value='';
  document.getElementById('g-desc').value='';
  buildCatSelect('g-cat','');
  openM('modal-gasto');
}
function openModalAg(){
  document.getElementById('ag-nombre').value='';
  document.getElementById('ag-inicio').value=today();
  document.getElementById('ag-sueldo').value='';
  document.getElementById('ag-meta').value='';
  document.getElementById('ag-com-int').value='';
  document.getElementById('ag-com-mov').value='';
  document.getElementById('ag-rol').value='Comercial';
  agColor='#00ffe1';
  document.querySelectorAll('#ag-colpick div').forEach((d,i)=>d.style.border=i===0?'2px solid #fff':'2px solid transparent');
  updateRolInfo();
  openM('modal-agente');
}
function openModalP(){buildSel('p-agente');document.getElementById('p-fecha').value=today();document.getElementById('p-monto').value='';document.getElementById('p-nota').value='';openM('modal-pago');}
function openModalDC(){
  const activos=ventas.filter(v=>!decomisiones.find(d=>d.ventaId===v.id)&&monthsAgo(v.fecha)<6);
  const s=document.getElementById('dc-venta');
  s.innerHTML=activos.length?activos.map(v=>{const ag=getAg(v.agenteId);return`<option value="${v.id}">${ag.nombre} ‚Äî ${v.cliente||'Sin ref.'} ‚Äî ${v.campana} ‚Äî ${fmt(v.comision)}</option>`;}).join(''):'<option value="">Sin ventas en riesgo activo</option>';
  document.getElementById('dc-fecha').value=today();document.getElementById('dc-monto').value='';openM('modal-decomision');
}

/* ‚îÄ‚îÄ‚îÄ SAVE ACTIONS ‚îÄ‚îÄ‚îÄ */
function saveVenta(){
  const ag=document.getElementById('v-agente').value,monto=parseFloat(document.getElementById('v-comision').value),camp=document.getElementById('v-camp').value.trim();
  if(!ag||!monto||!camp){toast('‚ö†Ô∏è Completa agente, campa√±a y comisi√≥n');return;}
  const nv={id:Date.now(),agenteId:parseInt(ag),fecha:document.getElementById('v-fecha').value,campana:camp,producto:document.getElementById('v-producto').value,cliente:document.getElementById('v-cliente').value,comision:monto,nota:document.getElementById('v-nota').value};
  ventas.push(nv);saveAll();closeModals();renderDashboard();renderVentas();toast('‚úÖ Venta registrada ‚Äî '+fmt(monto),'ok');
}
function saveGasto(){
  const m=parseFloat(document.getElementById('g-monto').value),d=document.getElementById('g-desc').value.trim();
  if(!m||!d){toast('‚ö†Ô∏è Completa descripci√≥n y monto');return;}
  gastos.push({id:Date.now(),fecha:document.getElementById('g-fecha').value,desc:d,cat:document.getElementById('g-cat').value,monto:m});
  saveAll();closeModals();renderDashboard();toast('‚úÖ Gasto registrado','ok');
}
function saveAgente(){
  const n=document.getElementById('ag-nombre').value.trim();
  if(!n){toast('‚ö†Ô∏è Escribe el nombre del agente');return;}
  const rol=document.getElementById('ag-rol').value||'Comercial';
  agentes.push({
    id:Date.now(),nombre:n,rol,
    inicio:document.getElementById('ag-inicio').value,
    sueldo:parseFloat(document.getElementById('ag-sueldo').value)||0,
    meta:parseInt(document.getElementById('ag-meta').value)||0,
    comInt:parseFloat(document.getElementById('ag-com-int').value)||0,
    comMov:parseFloat(document.getElementById('ag-com-mov').value)||0,
    color:agColor
  });
  saveAll();closeModals();renderAgentes();toast('‚úÖ Agente '+n+' ('+rol+') agregado','ok');
}
function savePago(){
  const ag=document.getElementById('p-agente').value,m=parseFloat(document.getElementById('p-monto').value);
  if(!ag||!m){toast('‚ö†Ô∏è Selecciona agente y monto');return;}
  pagos.push({id:Date.now(),agenteId:parseInt(ag),fecha:document.getElementById('p-fecha').value,tipo:document.getElementById('p-tipo').value,monto:m,nota:document.getElementById('p-nota').value});
  saveAll();closeModals();renderNomina();toast('‚úÖ Pago registrado ‚Äî '+fmt(m),'ok');
}
function openModalB(){
  buildSel('b-agente');
  document.getElementById('b-fecha').value=today();
  document.getElementById('b-monto').value='';
  document.getElementById('b-motivo').value='';
  const now=new Date();
  const sel=document.getElementById('b-mes-ref');
  sel.innerHTML='';
  for(let i=0;i<6;i++){
    const d=new Date(now.getFullYear(),now.getMonth()-i,1);
    const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
    const opt=document.createElement('option');
    opt.value=key;opt.textContent=getMesLabel(key);
    if(i===0)opt.selected=true;
    sel.appendChild(opt);
  }
  openM('modal-bono');
}
function saveBono(){
  const ag=document.getElementById('b-agente').value,m=parseFloat(document.getElementById('b-monto').value);
  if(!ag||!m){toast('‚ö†Ô∏è Selecciona agente y monto');return;}
  const fecha=document.getElementById('b-fecha').value||today();
  const mesRef=document.getElementById('b-mes-ref').value||getMesKey(fecha);
  bonos.push({id:Date.now(),agenteId:parseInt(ag),fecha,mesRef,monto:m,motivo:document.getElementById('b-motivo').value});
  saveAll();closeModals();renderNomina();toast('üéÅ Bono asignado ‚Äî '+fmt(m)+' ('+getMesLabel(mesRef)+')','ok');
}
function saveDecomision(){
  const vId=parseInt(document.getElementById('dc-venta').value),m=parseFloat(document.getElementById('dc-monto').value);
  if(!vId||!m){toast('‚ö†Ô∏è Selecciona venta y monto');return;}
  decomisiones.push({id:Date.now(),ventaId:vId,fecha:document.getElementById('dc-fecha').value,monto:m,motivo:document.getElementById('dc-motivo').value});
  saveAll();closeModals();renderDashboard();renderDecomisiones();toast('‚ö†Ô∏è Decomisi√≥n registrada ‚Äî '+fmt(m),'warn');
}

/* ‚îÄ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ */
function togglePass(id,btn){const i=document.getElementById(id);i.type=i.type==='password'?'text':'password';btn.textContent=i.type==='password'?'üëÅ':'üôà';}
function switchTab(t){
  document.getElementById('tab-login').classList.toggle('active',t==='login');
  document.getElementById('tab-register').classList.toggle('active',t==='register');
  document.getElementById('form-login').style.display=t==='login'?'block':'none';
  document.getElementById('form-register').style.display=t==='register'?'block':'none';
  if(t==='login') renderQuickUsers();
}
function renderQuickUsers(){
  const us=getUsers();const w=document.getElementById('quick-wrap');const l=document.getElementById('quick-list');
  if(!us.length){w.style.display='none';return;}
  w.style.display='block';
  l.innerHTML=us.map(u=>`<button class="l-qbtn" onclick="quickLogin('${u.username}','${u.password}')">
    <div style="width:30px;height:30px;border-radius:7px;background:linear-gradient(135deg,var(--neon),var(--purple));display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:#04060f;">${(u.fullname||u.username).slice(0,2).toUpperCase()}</div>
    <div><div style="font-size:12px;font-weight:600;color:var(--txt);text-transform:none;">${u.fullname||u.username}</div><div style="font-size:9.5px;color:var(--txt3);font-family:'DM Mono',monospace;">@${u.username}</div></div>
    <span>entrar</span></button>`).join('');
}
function doLogin(){
  const user=document.getElementById('l-user').value.trim().toLowerCase(),pass=document.getElementById('l-pass').value;
  const err=document.getElementById('l-error');err.classList.remove('show');
  if(!user||!pass){err.textContent='‚ö† Completa los campos';err.classList.add('show');return;}
  const us=getUsers(),found=us.find(u=>(u.username===user||u.email===user)&&u.password===pass);
  if(!found){err.classList.add('show');return;}
  document.getElementById('l-loading').classList.add('show');
  document.querySelector('#form-login .btn-login').style.display='none';
  setTimeout(()=>enterApp(found),1200);
}
function quickLogin(username,password){document.getElementById('l-user').value=username;document.getElementById('l-pass').value=password;doLogin();}
function doRegister(){
  const n=document.getElementById('r-nombre').value.trim(),ap=document.getElementById('r-apellido').value.trim();
  const em=document.getElementById('r-email').value.trim().toLowerCase(),us=document.getElementById('r-user').value.trim().toLowerCase();
  const p=document.getElementById('r-pass').value,p2=document.getElementById('r-pass2').value;
  const err=document.getElementById('r-error'),ok=document.getElementById('r-success');
  err.classList.remove('show');ok.classList.remove('show');
  if(!n||!ap||!em||!us||!p){err.textContent='‚ö† Completa todos los campos';err.classList.add('show');return;}
  if(p.length<6){err.textContent='‚ö† M√≠nimo 6 caracteres';err.classList.add('show');return;}
  if(p!==p2){err.textContent='‚ö† Las contrase√±as no coinciden';err.classList.add('show');return;}
  const users=getUsers();if(users.find(u=>u.username===us)){err.textContent='‚ö† Usuario ya existe';err.classList.add('show');return;}
  users.push({username:us,password:p,fullname:n+' '+ap,email:em});saveUsers(users);ok.classList.add('show');
  setTimeout(()=>{switchTab('login');ok.classList.remove('show');},1500);
}
function enterApp(u){
  setUser(u);
  document.getElementById('sb-avatar').textContent=(u.fullname||u.username).slice(0,2).toUpperCase();
  document.getElementById('sb-uname').textContent=u.fullname||u.username;
  loadAll();
  const sc=document.getElementById('login-screen');
  sc.classList.add('hiding');
  setTimeout(()=>{
    sc.classList.add('hidden');
    updateGSUI();
    renderDashboard(); // siempre muestra el dashboard primero
    toast('üëã Bienvenido, '+(u.fullname||u.username).split(' ')[0]+'!','ok');
    if(GS.enabled) syncBackground(); // sync en segundo plano, sin bloquear
  },500);
}
function doLogout(){clearSession();const sc=document.getElementById('login-screen');sc.classList.remove('hidden','hiding');document.getElementById('l-user').value='';document.getElementById('l-pass').value='';document.getElementById('l-loading').classList.remove('show');document.querySelector('#form-login .btn-login').style.display='';document.getElementById('l-error').classList.remove('show');document.getElementById('user-dropdown').classList.remove('open');renderQuickUsers();toast('üëã Sesi√≥n cerrada');}
function toggleUserMenu(){document.getElementById('user-dropdown').classList.toggle('open');}
document.addEventListener('click',e=>{const w=document.getElementById('user-menu-wrap');if(w&&!w.contains(e.target))document.getElementById('user-dropdown').classList.remove('open');});
function showProfileModal(){document.getElementById('user-dropdown').classList.remove('open');const u=getUser();if(!u)return;document.getElementById('pf-fullname').value=u.fullname||'';document.getElementById('pf-newpass').value='';document.getElementById('pf-newpass2').value='';document.getElementById('pf-error').classList.remove('show');document.getElementById('pf-success').classList.remove('show');openM('modal-profile');}
function saveProfile(){
  const u=getUser();if(!u)return;const n=document.getElementById('pf-fullname').value.trim();const np=document.getElementById('pf-newpass').value;const np2=document.getElementById('pf-newpass2').value;
  const err=document.getElementById('pf-error'),ok=document.getElementById('pf-success');err.classList.remove('show');ok.classList.remove('show');
  if(!n){err.textContent='‚ö† El nombre no puede estar vac√≠o';err.classList.add('show');return;}
  if(np&&np.length<6){err.textContent='‚ö† M√≠nimo 6 caracteres';err.classList.add('show');return;}
  if(np&&np!==np2){err.textContent='‚ö† Las contrase√±as no coinciden';err.classList.add('show');return;}
  const users=getUsers();const idx=users.findIndex(x=>x.username===u.username);users[idx].fullname=n;if(np)users[idx].password=np;saveUsers(users);setUser(users[idx]);
  document.getElementById('sb-uname').textContent=n;ok.classList.add('show');
  setTimeout(()=>{closeM('modal-profile');toast('‚úÖ Perfil actualizado','ok');},1100);
}

/* ‚îÄ‚îÄ‚îÄ RECOVER ‚îÄ‚îÄ‚îÄ */
function openRecoverModal(){document.getElementById('rec-email').value='';document.getElementById('rec-error').classList.remove('show');document.getElementById('rec-ok').style.display='none';document.getElementById('rec-newpass-wrap').style.display='none';document.getElementById('rec-btn').textContent='Buscar cuenta';document.getElementById('rec-btn').onclick=findRecoverUser;openM('modal-recover');}
function findRecoverUser(){const email=document.getElementById('rec-email').value.trim().toLowerCase();const err=document.getElementById('rec-error');err.classList.remove('show');if(!email){err.textContent='‚ö† Ingresa tu email';err.classList.add('show');return;}const users=getUsers();const found=users.find(u=>u.email===email);if(!found){err.textContent='‚ö† Email no encontrado en este dispositivo';err.classList.add('show');return;}const ok=document.getElementById('rec-ok');ok.textContent='‚úÖ Cuenta encontrada: @'+found.username+'. Elige nueva contrase√±a:';ok.style.display='block';document.getElementById('rec-newpass-wrap').style.display='block';document.getElementById('rec-btn').textContent='Cambiar contrase√±a';document.getElementById('rec-btn').onclick=()=>confirmRecover(email);}
function confirmRecover(email){const np=document.getElementById('rec-newpass').value;const np2=document.getElementById('rec-newpass2').value;const err=document.getElementById('rec-error');err.classList.remove('show');if(np.length<6){err.textContent='‚ö† M√≠nimo 6 caracteres';err.classList.add('show');return;}if(np!==np2){err.textContent='‚ö† Las contrase√±as no coinciden';err.classList.add('show');return;}const users=getUsers();const idx=users.findIndex(u=>u.email===email);users[idx].password=np;saveUsers(users);closeM('modal-recover');toast('‚úÖ Contrase√±a actualizada','ok');}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
(function(){
  const u=getUser();
  if(u){
    const users=getUsers();
    const v=users.find(x=>x.username===u.username);
    if(v){
      const sc=document.getElementById('login-screen');
      sc.style.opacity='0';sc.style.transition='none';
      document.getElementById('sb-avatar').textContent=(v.fullname||v.username).slice(0,2).toUpperCase();
      document.getElementById('sb-uname').textContent=v.fullname||v.username;
      setTimeout(()=>{
        sc.classList.add('hidden');sc.style.opacity='';sc.style.transition='';
        loadAll();
        updateGSUI();
        renderDashboard(); // muestra dashboard inmediatamente con datos locales
        if(GS.enabled) syncBackground(); // sync en segundo plano
      },30);
    } else clearSession();
  }
  renderQuickUsers();
})();
</script>
</body>
</html>
